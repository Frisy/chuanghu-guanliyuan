<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>数据导入管理 - 居家长护业务管理系统</title>
  <!-- 引入外部资源 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <style>
    /* 继承全局样式 */
    body { font-family: "微软雅黑", "思源黑体", sans-serif; background-color: #f5f7fa; color: #333; }
    .btn-primary { background-color: #1890FF; border-color: #1890FF; }
    .btn-primary:hover { background-color: #096DD9; border-color: #096DD9; }
    .btn-outline-secondary { border-color: #ddd; color: #666; }
    .btn-outline-secondary:hover { background-color: #f5f5f5; border-color: #ccc; }
    .btn-danger { background-color: #FF4D4F; border-color: #FF4D4F; }
    .btn-danger:hover { background-color: #F5222D; border-color: #F5222D; }
    .card { border: none; border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,0.08); margin-bottom: 20px; }
    .card-header { background: #fff; border-bottom: 1px solid #f0f0f0; border-radius: 12px 12px 0 0; padding: 15px 20px; font-weight: 600; font-size: 15px; }
    .card-body { padding: 20px; }
    /* 布局样式 */
    .app-container { display: flex; min-height: 100vh; }
    /* 侧边导航 */
    .sidebar { width: 220px; background: #fff; box-shadow: 1px 0 2px rgba(0,0,0,0.05); padding: 20px 0; flex-shrink: 0; }
    .sidebar-logo { text-align: center; padding: 0 20px 20px; border-bottom: 1px solid #f0f0f0; margin-bottom: 20px; }
    .sidebar-logo img { height: 40px; margin-bottom: 8px; }
    .sidebar-logo h3 { font-size: 16px; color: #1890FF; font-weight: 600; margin: 0; }
    .nav-menu { list-style: none; padding: 0; margin: 0; }
    .nav-item { margin-bottom: 4px; }
    .nav-link { display: flex; align-items: center; padding: 12px 20px; color: #666; text-decoration: none; font-size: 14px; border-left: 3px solid transparent; }
    .nav-link:hover, .nav-link.active { color: #1890FF; background-color: #f0f7ff; border-left: 3px solid #1890FF; }
    .nav-link i { font-size: 18px; margin-right: 12px; width: 20px; text-align: center; }
    .nav-group-title { padding: 15px 20px 5px; font-size: 12px; color: #999; font-weight: 500; }
    /* 主内容区 */
    .main-content { flex: 1; padding: 20px; overflow-y: auto; }
    /* 顶部导航 */
    .top-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .page-title { font-size: 20px; font-weight: 600; color: #333; margin: 0; }
    .user-info { display: flex; align-items: center; }
    .notification { position: relative; margin-right: 20px; cursor: pointer; }
    .notification i { font-size: 20px; color: #666; }
    .notification-badge { position: absolute; top: -5px; right: -5px; width: 18px; height: 18px; background: #FF4D4F; color: #fff; border-radius: 50%; font-size: 12px; text-align: center; line-height: 18px; }
    .user-avatar { width: 40px; height: 40px; border-radius: 50%; background: #1890FF; color: #fff; display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: 600; margin-right: 10px; }
    .user-name { font-size: 14px; font-weight: 500; }
    /* 导入页面专属样式 */
    .tab-content { margin-top: 20px; }
    .import-section { margin-bottom: 30px; }
    .import-desc { color: #666; font-size: 13px; margin-bottom: 15px; line-height: 1.6; }
    .template-download { margin-bottom: 20px; }
    .template-btn { margin-right: 10px; margin-bottom: 10px; }
    .upload-area { border: 2px dashed #dee2e6; border-radius: 8px; padding: 30px; text-align: center; transition: all 0.3s ease; cursor: pointer; margin-bottom: 20px; }
    .upload-area:hover { border-color: #1890FF; background-color: rgba(24, 144, 255, 0.05); }
    .upload-area i { font-size: 36px; color: #1890FF; margin-bottom: 10px; }
    .upload-area p { margin: 0; color: #666; font-size: 14px; }
    .uploaded-file { display: flex; align-items: center; padding: 10px; background-color: #f5f5f5; border-radius: 6px; margin-bottom: 15px; }
    .uploaded-file-icon { font-size: 20px; color: #1890FF; margin-right: 10px; }
    .uploaded-file-info { flex: 1; }
    .uploaded-file-name { font-weight: 500; font-size: 14px; margin-bottom: 3px; }
    .uploaded-file-size { font-size: 12px; color: #999; }
    .uploaded-file-remove { color: #FF4D4F; cursor: pointer; font-size: 16px; }
    .uploaded-file-remove:hover { color: #F5222D; }
    .import-result { margin-top: 20px; padding: 15px; border-radius: 8px; background-color: #f8f9fa; border: 1px solid #e9ecef; }
    .result-stats { display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 15px; }
    .result-stat-item { display: flex; align-items: center; }
    .result-stat-icon { width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 8px; font-size: 12px; color: #fff; }
    .stat-success { background-color: #52C41A; }
    .stat-fail { background-color: #FF4D4F; }
    .stat-duplicate { background-color: #FAAD14; }
    .result-table { margin-top: 15px; max-height: 300px; overflow-y: auto; }
    .text-danger { color: #FF4D4F !important; }
    .badge-warning { background-color: #FFF7E6; color: #FAAD14; padding: 3px 6px; border-radius: 4px; font-size: 12px; }
    .collapse-section { margin-top: 15px; }
    .collapse-header { display: flex; align-items: center; cursor: pointer; color: #1890FF; font-weight: 500; }
    .collapse-header i { margin-right: 8px; transition: transform 0.3s; }
    .collapse-header[aria-expanded="true"] i { transform: rotate(180deg); }
    .required-mark { color: #FF4D4F; margin-left: 2px; }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- 侧边导航 -->
    <div class="sidebar">
      <div class="sidebar-logo">
          <img src="https://via.placeholder.com/80x40?text=居家长护" alt="系统Logo">
          <h3>管理员工作平台</h3>
      </div>
      
      <!-- 导航分组：系统配置 -->
      <div class="nav-group-title">系统配置</div>
      <ul class="nav-menu">
          <li class="nav-item">
              <a href="index.html" class="nav-link">
                  <i class="fa fa-building-o"></i>
                  <span>机构信息配置</span>
              </a>
          </li>
          <li class="nav-item">
              <a href="套餐管理.html" class="nav-link">
                  <i class="fa fa-cog"></i>
                  <span>套餐管理</span>
              </a>
          </li>
          <li class="nav-item">
              <a href="行政区划.html" class="nav-link">
                  <i class="fa fa-book"></i>
                  <span>行政区域管理</span>
              </a>
          </li>
      </ul>
      
      <!-- 导航分组：用户管理 -->
      <div class="nav-group-title">用户管理</div>
      <ul class="nav-menu">
          <li class="nav-item">
              <a href="角色配置.html" class="nav-link">
                  <i class="fa fa-user-secret"></i>
                  <span>角色权限配置</span>
              </a>
          </li>
      </ul>
      
      <!-- 导航分组：日志管理 -->
      <div class="nav-group-title">数据管理</div>
      <ul class="nav-menu">
          <li class="nav-item">
              <a href="服务线索批量导入.html" class="nav-link">
                  <i class="fa fa-upload"></i>
                  <span>服务对象数据批量导入</span>
              </a>
          </li>
          <li class="nav-item">
              <a href="服务对象数据维护.html" class="nav-link">
                  <i class="fa fa-edit"></i>
                  <span>服务对象数据维护</span>
              </a>
          </li>
          <li class="nav-item">
              <a href="医保工单导入.html" class="nav-link active">
                  <i class="fa fa-file-excel-o"></i>
                  <span>医保平台工单导入</span>
              </a>
          </li>
          <li class="nav-item">
              <a href="医保平台新增服务对象数据.html" class="nav-link">
                  <i class="fa fa-download"></i>
                  <span>医保平台新增服务对象数据导出</span>
              </a>
          </li>
          <li class="nav-item">
              <a href="医保对账数据管理.html" class="nav-link">
                  <i class="fa fa-calculator"></i>
                  <span>医保对账数据管理</span>
              </a>
          </li>
          <li class="nav-item">
              <a href="关键数据配置.html" class="nav-link">
                  <i class="fa fa-wrench"></i>
                  <span>其他数据维护</span>
              </a>
          </li>
      </ul>
  </div>

    <!-- 主内容区 -->
    <div class="main-content">
      <!-- 顶部导航：标题 + 操作按钮 -->
      <div class="top-nav">
        <h1 class="page-title">数据导入管理</h1>
        <div class="user-info">
          <div class="notification">
            <i class="fa fa-bell-o"></i>
            <span class="notification-badge">3</span>
          </div>
          <div class="user-avatar">管</div>
          <div class="user-name">系统管理员</div>
        </div>
      </div>

      <!-- 导入功能选项卡 -->
      <div class="card">
        <div class="card-header">导入功能选择</div>
        <div class="card-body">
          <nav>
            <div class="nav nav-tabs" id="importTabs" role="tablist">
              <button class="nav-link active" id="medicalWorkOrder-tab" data-bs-toggle="tab" data-bs-target="#medicalWorkOrder" type="button" role="tab" aria-controls="medicalWorkOrder" aria-selected="true">医保工单追加导入</button>
              <button class="nav-link" id="batchDataImport-tab" data-bs-toggle="tab" data-bs-target="#batchDataImport" type="button" role="tab" aria-controls="batchDataImport" aria-selected="false">服务对象/护理员批量导入</button>
            </div>
          </nav>
          <div class="tab-content" id="importTabsContent">
            <!-- 选项卡1：医保工单追加导入 -->
            <div class="tab-pane fade show active" id="medicalWorkOrder" role="tabpanel" aria-labelledby="medicalWorkOrder-tab">
              <div class="import-section">
                <h5>医保工单追加导入</h5>
                <p class="import-desc">支持多次追加导入医保平台已完成工单数据，系统自动去重（按“服务对象身份证号+服务日期+开始时间”判断），避免重复数据。导入前请下载模板并按要求填写。</p>
                
                <!-- 模板下载 -->
                <div class="template-download">
                  <button class="btn btn-outline-secondary template-btn" id="downloadMedicalTemplate">
                    <i class="fa fa-download"></i> 下载医保工单导入模板
                  </button>
                  <span class="text-muted" style="font-size: 12px;">模板包含字段：服务对象姓名、身份证号、服务日期、开始时间、结束时间、护理员工号</span>
                </div>
                
                <!-- 文件上传区 -->
                <div class="upload-area" id="medicalUploadArea">
                  <i class="fa fa-cloud-upload"></i>
                  <p>点击或拖拽Excel文件到此处（支持.xlsx/.xls格式，最大10MB）</p>
                </div>
                <input type="file" id="medicalFileInput" class="d-none" accept=".xlsx,.xls">
                <div id="medicalUploadedFile" style="display: none;"></div>
                
                <!-- 导入按钮 -->
                <button class="btn btn-primary" id="importMedicalBtn">
                  <i class="fa fa-upload"></i> 开始导入
                </button>
                
                <!-- 导入结果（默认隐藏） -->
                <div class="import-result" id="medicalImportResult" style="display: none;">
                  <div class="result-stats">
                    <div class="result-stat-item">
                      <span class="result-stat-icon stat-success"><i class="fa fa-check"></i></span>
                      <span>成功导入：<strong id="medicalSuccessCount">0</strong> 条</span>
                    </div>
                    <div class="result-stat-item">
                      <span class="result-stat-icon stat-fail"><i class="fa fa-times"></i></span>
                      <span>导入失败：<strong id="medicalFailCount">0</strong> 条</span>
                    </div>
                    <div class="result-stat-item">
                      <span class="result-stat-icon stat-duplicate"><i class="fa fa-exclamation"></i></span>
                      <span>自动去重：<strong id="medicalDuplicateCount">0</strong> 条</span>
                    </div>
                  </div>
                  
                  <!-- 失败详情（折叠） -->
                  <div class="collapse-section">
                    <button class="btn btn-link collapse-header p-0" type="button" data-bs-toggle="collapse" data-bs-target="#medicalFailDetails" aria-expanded="false" aria-controls="medicalFailDetails">
                      <i class="fa fa-chevron-down"></i> 查看失败详情
                    </button>
                    <div class="collapse" id="medicalFailDetails">
                      <div class="result-table">
                        <table class="table table-sm table-hover table-striped">
                          <thead>
                            <tr>
                              <th>行号</th>
                              <th>服务对象姓名</th>
                              <th>身份证号</th>
                              <th>失败原因</th>
                            </tr>
                          </thead>
                          <tbody id="medicalFailTableBody">
                            <!-- 失败数据示例 -->
                            <!-- <tr>
                              <td>3</td>
                              <td>张三</td>
                              <td>110101********1234</td>
                              <td><span class="text-danger">未找到对应服务对象</span></td>
                            </tr> -->
                          </tbody>
                        </table>
                      </div>
                      <button class="btn btn-outline-secondary btn-sm mt-2" id="downloadMedicalFailBtn">
                        <i class="fa fa-download"></i> 下载失败明细
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- 选项卡2：服务对象/护理员批量导入 -->
            <div class="tab-pane fade" id="batchDataImport" role="tabpanel" aria-labelledby="batchDataImport-tab">
              <div class="import-section">
                <h5>服务对象/护理员批量导入</h5>
                <p class="import-desc">支持批量导入历史服务对象或护理员数据，分模板导入，护理员导入可批量上传资质材料压缩包（按“姓名-材料类型”命名）。</p>
                
                <!-- 模板下载 -->
                <div class="template-download">
                  <button class="btn btn-outline-secondary template-btn" id="downloadServiceObjectTemplate">
                    <i class="fa fa-download"></i> 下载服务对象导入模板
                  </button>
                  <button class="btn btn-outline-secondary template-btn" id="downloadCaregiverTemplate">
                    <i class="fa fa-download"></i> 下载护理员导入模板
                  </button>
                  <div class="mt-2">
                    <span class="text-muted" style="font-size: 12px;">服务对象模板字段：姓名、身份证号、失能等级、评估结论、居住地址、家属联系电话</span><br>
                    <span class="text-muted" style="font-size: 12px;">护理员模板字段：姓名、工号、身份证号、资质类型、紧急联系人、联系电话</span>
                  </div>
                </div>
                
                <!-- 数据文件上传区 -->
                <div class="upload-area" id="batchUploadArea">
                  <i class="fa fa-cloud-upload"></i>
                  <p>点击或拖拽Excel文件到此处（支持.xlsx/.xls格式，最大10MB）</p>
                </div>
                <input type="file" id="batchFileInput" class="d-none" accept=".xlsx,.xls">
                <div id="batchUploadedFile" style="display: none;"></div>
                
                <!-- 护理员资质材料上传区（默认隐藏） -->
                <div id="caregiverMaterialSection" style="display: none; margin-top: 20px;">
                  <label class="form-label">护理员资质材料压缩包 <span class="text-muted">(可选，支持.zip/.rar格式，最大20MB)</span></label>
                  <div class="upload-area" id="materialUploadArea">
                    <i class="fa fa-cloud-upload"></i>
                    <p>点击或拖拽压缩包到此处（文件命名规则：姓名-材料类型.jpg，如“张三-职业证书.jpg”）</p>
                  </div>
                  <input type="file" id="materialFileInput" class="d-none" accept=".zip,.rar">
                  <div id="materialUploadedFile" style="display: none;"></div>
                </div>
                
                <!-- 导入按钮 -->
                <button class="btn btn-primary" id="importBatchBtn">
                  <i class="fa fa-upload"></i> 开始导入
                </button>
                
                <!-- 导入结果（默认隐藏） -->
                <div class="import-result" id="batchImportResult" style="display: none;">
                  <div class="result-stats">
                    <div class="result-stat-item">
                      <span class="result-stat-icon stat-success"><i class="fa fa-check"></i></span>
                      <span>成功导入：<strong id="batchSuccessCount">0</strong> 条</span>
                    </div>
                    <div class="result-stat-item">
                      <span class="result-stat-icon stat-fail"><i class="fa fa-times"></i></span>
                      <span>导入失败：<strong id="batchFailCount">0</strong> 条</span>
                    </div>
                    <div class="result-stat-item">
                      <span class="result-stat-icon stat-duplicate"><i class="fa fa-exclamation"></i></span>
                      <span>自动去重：<strong id="batchDuplicateCount">0</strong> 条</span>
                    </div>
                  </div>
                  
                  <!-- 失败详情（折叠） -->
                  <div class="collapse-section">
                    <button class="btn btn-link collapse-header p-0" type="button" data-bs-toggle="collapse" data-bs-target="#batchFailDetails" aria-expanded="false" aria-controls="batchFailDetails">
                      <i class="fa fa-chevron-down"></i> 查看失败详情
                    </button>
                    <div class="collapse" id="batchFailDetails">
                      <div class="result-table">
                        <table class="table table-sm table-hover table-striped">
                          <thead>
                            <tr>
                              <th>行号</th>
                              <th>姓名</th>
                              <th>身份证号/工号</th>
                              <th>失败原因</th>
                            </tr>
                          </thead>
                          <tbody id="batchFailTableBody">
                            <!-- 失败数据示例 -->
                          </tbody>
                        </table>
                      </div>
                      <button class="btn btn-outline-secondary btn-sm mt-2" id="downloadBatchFailBtn">
                        <i class="fa fa-download"></i> 下载失败明细
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 模态框：操作提示 -->
  <div class="modal fade" id="promptModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm">
      <div class="modal-content">
        <div class="modal-body text-center py-4">
          <i class="fa fa-info-circle text-primary" style="font-size: 36px; margin-bottom: 15px;"></i>
          <h5 class="modal-title" id="promptTitle">操作提示</h5>
          <p class="text-muted" id="promptMsg">模板下载中，请稍后...</p>
        </div>
        <div class="modal-footer justify-content-center">
          <button type="button" class="btn btn-primary" data-bs-dismiss="modal">确定</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 模态框：导入中 -->
  <div class="modal fade" id="importingModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-sm">
      <div class="modal-content">
        <div class="modal-body text-center py-4">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <h5 class="modal-title mt-3">导入中</h5>
          <p class="text-muted" id="importingMsg">正在处理数据，请不要关闭此窗口...</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // 页面加载完成后初始化
    $(function() {
      // 初始化模态框
      const promptModal = new bootstrap.Modal('#promptModal');
      const importingModal = new bootstrap.Modal('#importingModal');

      // 全局变量：存储上传的文件信息
      let medicalFile = null;
      let batchFile = null;
      let materialFile = null;
      let importType = 'medical'; // 当前导入类型：medical（医保工单）、batch（批量数据）

      // 1. 模板下载按钮点击事件
      $('#downloadMedicalTemplate').click(function() {
        showPrompt('模板下载中', '正在准备医保工单导入模板，请稍后...');
        // 模拟下载延迟
        setTimeout(() => {
          promptModal.hide();
          // 实际项目中触发文件下载：window.location.href = '/api/download/template/medical-work-order';
        }, 1000);
      });

      $('#downloadServiceObjectTemplate').click(function() {
        showPrompt('模板下载中', '正在准备服务对象导入模板，请稍后...');
        setTimeout(() => {
          promptModal.hide();
          // window.location.href = '/api/download/template/service-object';
        }, 1000);
      });

      $('#downloadCaregiverTemplate').click(function() {
        showPrompt('模板下载中', '正在准备护理员导入模板，请稍后...');
        setTimeout(() => {
          promptModal.hide();
          // window.location.href = '/api/download/template/caregiver';
        }, 1000);
      });

      // 2. 医保工单文件上传处理
      const medicalUploadArea = $('#medicalUploadArea');
      const medicalFileInput = $('#medicalFileInput');
      const medicalUploadedFile = $('#medicalUploadedFile');

      medicalUploadArea.click(() => medicalFileInput.click());
      medicalUploadArea.on('dragover', handleDragOver);
      medicalUploadArea.on('dragleave', handleDragLeave);
      medicalUploadArea.on('drop', (e) => handleDrop(e, 'medical'));
      medicalFileInput.change((e) => handleFileChange(e, 'medical'));

      // 3. 批量数据文件上传处理
      const batchUploadArea = $('#batchUploadArea');
      const batchFileInput = $('#batchFileInput');
      const batchUploadedFile = $('#batchUploadedFile');
      const caregiverMaterialSection = $('#caregiverMaterialSection');

      batchUploadArea.click(() => batchFileInput.click());
      batchUploadArea.on('dragover', handleDragOver);
      batchUploadArea.on('dragleave', handleDragLeave);
      batchUploadArea.on('drop', (e) => handleDrop(e, 'batch'));
      batchFileInput.change((e) => handleFileChange(e, 'batch'));

      // 4. 护理员资质材料上传处理
      const materialUploadArea = $('#materialUploadArea');
      const materialFileInput = $('#materialFileInput');
      const materialUploadedFile = $('#materialUploadedFile');

      materialUploadArea.click(() => materialFileInput.click());
      materialUploadArea.on('dragover', handleDragOver);
      materialUploadArea.on('dragleave', handleDragLeave);
      materialUploadArea.on('drop', (e) => handleDrop(e, 'material'));
      materialFileInput.change((e) => handleFileChange(e, 'material'));

      // 5. 选项卡切换事件
      $('#importTabs button').click(function() {
        const target = $(this).data('bs-target');
        importType = target === '#medicalWorkOrder' ? 'medical' : 'batch';
        // 重置当前选项卡的上传状态
        if (importType === 'medical') {
          resetUpload('medical');
        } else {
          resetUpload('batch');
          resetUpload('material');
          caregiverMaterialSection.hide();
        }
        // 隐藏导入结果
        $('#medicalImportResult').hide();
        $('#batchImportResult').hide();
      });

      // 6. 导入按钮点击事件
      $('#importMedicalBtn').click(function() {
        if (!medicalFile) {
          showPrompt('操作提示', '请先上传医保工单Excel文件！');
          return;
        }
        startMedicalImport();
      });

      $('#importBatchBtn').click(function() {
        if (!batchFile) {
          showPrompt('操作提示', '请先上传数据Excel文件！');
          return;
        }
        startBatchImport();
      });

      // 7. 失败明细下载按钮点击事件
      $('#downloadMedicalFailBtn').click(function() {
        showPrompt('下载中', '正在准备失败明细文件，请稍后...');
        setTimeout(() => {
          promptModal.hide();
          // 实际项目中触发下载：window.location.href = '/api/download/fail-details/medical';
        }, 1000);
      });

      $('#downloadBatchFailBtn').click(function() {
        showPrompt('下载中', '正在准备失败明细文件，请稍后...');
        setTimeout(() => {
          promptModal.hide();
          // window.location.href = '/api/download/fail-details/batch';
        }, 1000);
      });

      // 公共函数：显示提示模态框
      function showPrompt(title, msg) {
        $('#promptTitle').text(title);
        $('#promptMsg').text(msg);
        promptModal.show();
      }

      // 公共函数：处理拖拽事件
      function handleDragOver(e) {
        e.preventDefault();
        e.stopPropagation();
        $(this).addClass('border-primary bg-primary/5');
      }

      function handleDragLeave(e) {
        e.preventDefault();
        e.stopPropagation();
        $(this).removeClass('border-primary bg-primary/5');
      }

      function handleDrop(e, type) {
        e.preventDefault();
        e.stopPropagation();
        $(this).removeClass('border-primary bg-primary/5');
        if (e.originalEvent.dataTransfer.files.length) {
          const file = e.originalEvent.dataTransfer.files[0];
          handleFile(file, type);
        }
      }

      // 公共函数：处理文件选择事件
      function handleFileChange(e, type) {
        const file = e.target.files[0];
        if (file) {
          handleFile(file, type);
        }
      }

      // 公共函数：处理文件上传（验证+显示）
      function handleFile(file, type) {
        // 验证文件格式和大小
        let isValid = true;
        let errorMsg = '';

        if (type === 'medical' || type === 'batch') {
          // Excel文件验证
          const ext = file.name.split('.').pop().toLowerCase();
          if (!['xlsx', 'xls'].includes(ext)) {
            isValid = false;
            errorMsg = '请上传Excel格式文件（.xlsx/.xls）！';
          } else if (file.size > 10 * 1024 * 1024) {
            isValid = false;
            errorMsg = '文件大小不能超过10MB！';
          }
        } else if (type === 'material') {
          // 压缩包文件验证
          const ext = file.name.split('.').pop().toLowerCase();
          if (!['zip', 'rar'].includes(ext)) {
            isValid = false;
            errorMsg = '请上传压缩包格式文件（.zip/.rar）！';
          } else if (file.size > 20 * 1024 * 1024) {
            isValid = false;
            errorMsg = '文件大小不能超过20MB！';
          }
        }

        if (!isValid) {
          showPrompt('文件格式错误', errorMsg);
          // 清空文件输入
          if (type === 'medical') medicalFileInput.val('');
          else if (type === 'batch') batchFileInput.val('');
          else if (type === 'material') materialFileInput.val('');
          return;
        }

        // 存储文件信息
        if (type === 'medical') {
          medicalFile = file;
          showUploadedFile(medicalUploadedFile, file, 'medical');
        } else if (type === 'batch') {
          batchFile = file;
          showUploadedFile(batchUploadedFile, file, 'batch');
          // 判断是否为护理员模板（根据文件名包含“护理员”判断，实际项目中可读取Excel表头判断）
          if (file.name.includes('护理员')) {
            caregiverMaterialSection.show();
          } else {
            caregiverMaterialSection.hide();
            resetUpload('material');
          }
        } else if (type === 'material') {
          materialFile = file;
          showUploadedFile(materialUploadedFile, file, 'material');
        }
      }

      // 公共函数：显示已上传的文件信息
      function showUploadedFile(container, file, type) {
        const fileSize = (file.size / 1024 / 1024).toFixed(2) + 'MB';
        container.html(`
          <div class="uploaded-file">
            <div class="uploaded-file-icon">
              <i class="fa fa-file-excel-o" style="color: ${type === 'material' ? '#FF4D4F' : '#52C41A'}"></i>
            </div>
            <div class="uploaded-file-info">
              <div class="uploaded-file-name">${file.name}</div>
              <div class="uploaded-file-size">${fileSize}</div>
            </div>
            <div class="uploaded-file-remove" data-type="${type}">
              <i class="fa fa-times"></i>
            </div>
          </div>
        `);
        container.show();

        // 绑定删除按钮事件
        container.find('.uploaded-file-remove').click(function() {
          const type = $(this).data('type');
          resetUpload(type);
        });
      }

      // 公共函数：重置上传状态
      function resetUpload(type) {
        if (type === 'medical') {
          medicalFile = null;
          medicalFileInput.val('');
          medicalUploadedFile.hide().html('');
        } else if (type === 'batch') {
          batchFile = null;
          batchFileInput.val('');
          batchUploadedFile.hide().html('');
        } else if (type === 'material') {
          materialFile = null;
          materialFileInput.val('');
          materialUploadedFile.hide().html('');
        }
      }

      // 医保工单导入模拟
      function startMedicalImport() {
        importingModal.show();
        $('#importingMsg').text('正在导入医保工单数据，请不要关闭此窗口...');

        // 模拟导入延迟（实际项目中调用后端接口）
        setTimeout(() => {
          importingModal.hide();
          
          // 模拟导入结果（实际从后端获取）
          const successCount = 18;
          const failCount = 2;
          const duplicateCount = 5;
          const failData = [
            { row: 3, name: '张三', idCard: '110101********1234', reason: '未找到对应服务对象' },
            { row: 7, name: '李四', idCard: '110102********5678', reason: '未找到对应护理员' }
          ];

          // 更新结果统计
          $('#medicalSuccessCount').text(successCount);
          $('#medicalFailCount').text(failCount);
          $('#medicalDuplicateCount').text(duplicateCount);

          // 更新失败表格
          const failTableBody = $('#medicalFailTableBody');
          failTableBody.empty();
          if (failCount > 0) {
            failData.forEach(item => {
              failTableBody.append(`
                <tr>
                  <td>${item.row}</td>
                  <td>${item.name}</td>
                  <td>${item.idCard}</td>
                  <td><span class="text-danger">${item.reason}</span></td>
                </tr>
              `);
            });
            // 展开失败详情
            $('#medicalFailDetails').collapse('show');
          } else {
            $('#medicalFailDetails').collapse('hide');
          }

          // 显示导入结果
          $('#medicalImportResult').show();
        }, 2000);
      }

      // 批量数据导入模拟
      function startBatchImport() {
        importingModal.show();
        $('#importingMsg').text('正在导入批量数据，请不要关闭此窗口...');

        // 模拟导入延迟
        setTimeout(() => {
          importingModal.hide();
          
          // 模拟导入结果
          const successCount = 25;
          const failCount = 3;
          const duplicateCount = 4;
          const failData = [
            { row: 2, name: '王五', id: '110103********9012', reason: '身份证号格式错误' },
            { row: 5, name: '赵六', id: '110104********3456', reason: '失能等级字段为空' },
            { row: 9, name: '孙七', id: '888888', reason: '护理员工号不存在' }
          ];

          // 更新结果统计
          $('#batchSuccessCount').text(successCount);
          $('#batchFailCount').text(failCount);
          $('#batchDuplicateCount').text(duplicateCount);

          // 更新失败表格
          const failTableBody = $('#batchFailTableBody');
          failTableBody.empty();
          if (failCount > 0) {
            failData.forEach(item => {
              failTableBody.append(`
                <tr>
                  <td>${item.row}</td>
                  <td>${item.name}</td>
                  <td>${item.id}</td>
                  <td><span class="text-danger">${item.reason}</span></td>
                </tr>
              `);
            });
            $('#batchFailDetails').collapse('show');
          } else {
            $('#batchFailDetails').collapse('hide');
          }

          // 显示导入结果
          $('#batchImportResult').show();
        }, 2500);
      }
    });
  </script>
</body>

</html>
