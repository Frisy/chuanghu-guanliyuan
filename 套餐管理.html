<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>系统管理平台 - 服务套餐管理</title>
  <!-- 外部资源引入 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
  <!-- 拖拽功能辅助库（可选，简化拖拽实现） -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  
  <style>
    /* 系统通用样式复用 */
    body { font-family: "微软雅黑", "思源黑体", sans-serif; background-color: #f5f7fa; color: #333; margin: 0; padding: 0; }
    .btn-primary { background-color: #1890FF; border-color: #1890FF; }
    .btn-primary:hover { background-color: #096DD9; border-color: #096DD9; }
    .btn-outline-secondary { border-color: #ddd; color: #666; }
    .btn-outline-secondary:hover { background-color: #f5f5f5; border-color: #ccc; }
    .btn-success { background-color: #52C41A; border-color: #52C41A; }
    .btn-success:hover { background-color: #43A047; border-color: #43A047; }
    .btn-danger { background-color: #FF4D4F; border-color: #FF4D4F; }
    .btn-danger:hover { background-color: #d9363e; border-color: #d9363e; }
    .card { border: none; border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,0.08); margin-bottom: 20px; }
    .card-header { background: #fff; border-bottom: 1px solid #f0f0f0; border-radius: 12px 12px 0 0; padding: 15px 20px; font-weight: 600; font-size: 15px; }
    .card-body { padding: 20px; }
    .badge { font-size: 12px; padding: 4px 8px; }

    /* 布局样式 */
    .app-container { display: flex; min-height: 100vh; }
    .sidebar { width: 220px; background: #fff; box-shadow: 1px 0 2px rgba(0,0,0,0.05); padding: 20px 0; flex-shrink: 0; }
    .sidebar-logo { text-align: center; padding: 0 20px 20px; border-bottom: 1px solid #f0f0f0; margin-bottom: 20px; }
    .sidebar-logo img { height: 40px; margin-bottom: 8px; }
    .sidebar-logo h3 { font-size: 16px; color: #1890FF; font-weight: 600; margin: 0; }
    .nav-menu { list-style: none; padding: 0; margin: 0; }
    .nav-item { margin-bottom: 4px; }
    .nav-link { display: flex; align-items: center; padding: 12px 20px; color: #666; text-decoration: none; font-size: 14px; border-left: 3px solid transparent; }
    .nav-link:hover, .nav-link.active { color: #1890FF; background-color: #f0f7ff; border-left: 3px solid #1890FF; }
    .nav-link i { font-size: 18px; margin-right: 12px; width: 20px; text-align: center; }
    .nav-group-title { padding: 15px 20px 5px; font-size: 12px; color: #999; font-weight: 500; }

    /* 主内容区 */
    .main-content { flex: 1; padding: 20px; overflow-y: auto; }
    .top-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .page-title { font-size: 20px; font-weight: 600; color: #333; margin: 0; }
    .user-info { display: flex; align-items: center; }
    .user-avatar { width: 40px; height: 40px; border-radius: 50%; background: #1890FF; color: #fff; display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: 600; margin-right: 10px; }
    .user-name { font-size: 14px; font-weight: 500; }

    /* 套餐管理专属样式 */
    .filter-bar { background: #fff; padding: 15px 20px; border-radius: 8px; margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 15px; align-items: center; }
    .filter-item { flex: 1; min-width: 180px; }
    .filter-item label { display: block; margin-bottom: 8px; font-weight: 500; font-size: 14px; }
    .filter-item select, .filter-item input { width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
    .filter-actions { display: flex; gap: 10px; align-items: flex-end; }
    
    .package-table { width: 100%; border-collapse: collapse; background: #fff; border-radius: 8px; overflow: hidden; }
    .package-table th, .package-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #f0f0f0; }
    .package-table th { background-color: #f8f9fa; font-weight: 600; font-size: 14px; }
    .package-table tbody tr:hover { background-color: #f9f9f9; }
    
    .status-enabled { background-color: #f6ffed; color: #52C41A; }
    .status-disabled { background-color: #f5f5f5; color: #999; }
    
    .action-buttons { display: flex; gap: 5px; }
    .btn-xs { padding: 2px 8px; font-size: 12px; }
    
    /* 编辑页样式 */
    .form-section { margin-bottom: 25px; }
    .form-section-title { font-size: 16px; font-weight: 600; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 1px solid #f0f0f0; }
    
    /* 项目选择区域 */
    .project-selection { display: flex; gap: 30px; margin-bottom: 20px; }
    .project-panel { flex: 1; background: #fff; border: 1px solid #f0f0f0; border-radius: 8px; padding: 15px; max-height: 450px; display: flex; flex-direction: column; }
    .panel-title { font-size: 14px; font-weight: 600; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px solid #f0f0f0; }
    .project-list { flex: 1; overflow-y: auto; padding: 5px; }
    .project-item { display: flex; align-items: center; padding: 8px 10px; border-radius: 4px; margin-bottom: 6px; cursor: pointer; border: 1px solid transparent; }
    .project-item:hover { background-color: #f0f7ff; border-color: #e6f7ff; }
    .project-item.selected { background-color: #e6f7ff; border-color: #1890FF; }
    .project-info { flex: 1; }
    .project-name { font-size: 13px; font-weight: 500; }
    .project-duration { font-size: 12px; color: #666; min-width: 70px; text-align: right; }
    .project-meta { font-size: 11px; color: #999; margin-top: 2px; }
    .gender-badge { display: inline-block; padding: 2px 6px; border-radius: 3px; font-size: 11px; margin-left: 5px; }
    .gender-badge.male { background-color: #e6f7ff; color: #1890FF; }
    .gender-badge.female { background-color: #fff0f6; color: #eb2f96; }
    
    /* 已选项目操作区 */
    .project-actions { display: flex; justify-content: center; gap: 10px; margin-top: 15px; }
    .duration-wrap { display: flex; align-items: center; gap: 15px; margin-top: 20px; padding-top: 15px; border-top: 1px solid #f0f0f0; }
    .readonly-input { background-color: #f5f5f5 !important; cursor: not-allowed; }
    .tip-text { font-size: 12px; color: #999; margin-left: 10px; }
    
    .bottom-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 30px; }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- 侧边导航栏 -->
    <div class="sidebar">
      <div class="sidebar-logo">
          <img src="https://via.placeholder.com/80x40?text=居家长护" alt="系统Logo">
          <h3>管理员工作平台</h3>
      </div>
      
      <!-- 导航分组：系统配置 -->
      <div class="nav-group-title">系统配置</div>
      <ul class="nav-menu">
          <li class="nav-item">
              <a href="index.html" class="nav-link">
                  <i class="fa fa-building-o"></i>
                  <span>机构信息配置</span>
              </a>
          </li>
          <li class="nav-item">
              <a href="套餐管理.html" class="nav-link active">
                  <i class="fa fa-cog"></i>
                  <span>套餐管理</span>
              </a>
          </li>
          <li class="nav-item">
              <a href="行政区划.html" class="nav-link">
                  <i class="fa fa-book"></i>
                  <span>行政区域管理</span>
              </a>
          </li>
      </ul>
      
      <!-- 导航分组：用户管理 -->
      <div class="nav-group-title">用户管理</div>
      <ul class="nav-menu">
          <li class="nav-item">
              <a href="角色配置.html" class="nav-link">
                  <i class="fa fa-user-secret"></i>
                  <span>角色权限配置</span>
              </a>
          </li>
      </ul>
      
      <!-- 导航分组：日志管理 -->
      <div class="nav-group-title">数据管理</div>
      <ul class="nav-menu">
          <li class="nav-item">
              <a href="服务线索批量导入.html" class="nav-link">
                  <i class="fa fa-upload"></i>
                  <span>服务对象数据批量导入</span>
              </a>
          </li>
          <li class="nav-item">
              <a href="服务对象数据维护.html" class="nav-link">
                  <i class="fa fa-edit"></i>
                  <span>服务对象数据维护</span>
              </a>
          </li>
          <li class="nav-item">
              <a href="医保工单导入.html" class="nav-link">
                  <i class="fa fa-file-excel-o"></i>
                  <span>医保平台工单导入</span>
              </a>
          </li>
          <li class="nav-item">
              <a href="医保平台新增服务对象数据.html" class="nav-link">
                  <i class="fa fa-download"></i>
                  <span>医保平台新增服务对象数据导出</span>
              </a>
          </li>
          <li class="nav-item">
              <a href="医保对账数据管理.html" class="nav-link">
                  <i class="fa fa-calculator"></i>
                  <span>医保对账数据管理</span>
              </a>
          </li>
          <li class="nav-item">
              <a href="关键数据配置.html" class="nav-link">
                  <i class="fa fa-wrench"></i>
                  <span>业务数据维护</span>
              </a>
          </li>
      </ul>
  </div>

    <!-- 套餐列表页 -->
    <div class="main-content" id="list-page">
      <div class="top-nav">
        <h1 class="page-title">服务套餐管理</h1>
        <div class="user-info">
          <div class="user-avatar">管</div>
          <div class="user-name">系统管理员</div>
        </div>
      </div>

      <!-- 筛选区域 -->
      <div class="filter-bar">
        <div class="filter-item">
          <label>套餐名称</label>
          <input type="text" id="filter-name" placeholder="请输入套餐名称">
        </div>
        <div class="filter-item">
          <label>套餐时长（分钟）</label>
          <input type="number" id="filter-duration" placeholder="输入时长筛选" min="1">
        </div>
        <div class="filter-item">
          <label>套餐状态</label>
          <select id="filter-status">
            <option value="">全部状态</option>
            <option value="enabled">启用</option>
            <option value="disabled">禁用</option>
          </select>
        </div>
        <div class="filter-actions">
          <button class="btn btn-primary" onclick="queryPackage()">
            <i class="fa fa-search"></i> 查询
          </button>
          <button class="btn btn-outline-secondary" onclick="resetFilter()">
            <i class="fa fa-refresh"></i> 重置
          </button>
        </div>
        <div class="ms-auto">
          <button class="btn btn-primary" onclick="openEditPage('add')">
            <i class="fa fa-plus"></i> 新增套餐
          </button>
        </div>
      </div>

      <!-- 套餐列表表格 -->
      <div class="card">
        <div class="card-header">套餐列表</div>
        <div class="card-body p-0">
          <table class="package-table">
            <thead>
              <tr>
                <th>套餐名称</th>
                <th>包含项目数</th>
                <th>套餐时长（分钟）</th>
                <th>创建时间</th>
                <th>状态</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody id="package-table-body">
              <tr>
                <td>基础护理套餐</td>
                <td>8项</td>
                <td>180</td>
                <td>2024-10-15 10:20:30</td>
                <td><span class="badge status-enabled">启用</span></td>
                <td class="action-buttons">
                  <button class="btn btn-xs btn-outline-secondary" onclick="openEditPage('edit', 1)">编辑</button>
                  <button class="btn btn-xs btn-outline-secondary" onclick="openEditPage('copy', 1)">复制</button>
                  <button class="btn btn-xs btn-danger" onclick="changeStatus(1, 'disabled')">禁用</button>
                </td>
              </tr>
              <tr>
                <td>重度失能护理套餐</td>
                <td>12项</td>
                <td>240</td>
                <td>2024-10-20 14:15:22</td>
                <td><span class="badge status-enabled">启用</span></td>
                <td class="action-buttons">
                  <button class="btn btn-xs btn-outline-secondary" onclick="openEditPage('edit', 2)">编辑</button>
                  <button class="btn btn-xs btn-outline-secondary" onclick="openEditPage('copy', 2)">复制</button>
                  <button class="btn btn-xs btn-danger" onclick="changeStatus(2, 'disabled')">禁用</button>
                </td>
              </tr>
              <tr>
                <td>康复护理套餐</td>
                <td>3项</td>
                <td>120</td>
                <td>2024-09-30 09:30:15</td>
                <td><span class="badge status-disabled">禁用</span></td>
                <td class="action-buttons">
                  <button class="btn btn-xs btn-outline-secondary" onclick="openEditPage('edit', 3)">编辑</button>
                  <button class="btn btn-xs btn-outline-secondary" onclick="openEditPage('copy', 3)">复制</button>
                  <button class="btn btn-xs btn-success" onclick="changeStatus(3, 'enabled')">启用</button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- 套餐编辑页（新增/编辑/复制） -->
    <div class="main-content" id="edit-page" style="display: none;">
      <div class="top-nav">
        <h1 class="page-title" id="edit-title">新增服务套餐</h1>
        <div class="user-info">
          <div class="user-avatar">管</div>
          <div class="user-name">系统管理员</div>
        </div>
      </div>

      <div class="card">
        <div class="card-body">
          <!-- 基础信息区 -->
          <div class="form-section">
            <div class="form-section-title">基础信息</div>
            <div class="row gap-3">
              <div class="col-md-12">
                <label class="form-label">套餐名称 <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="package-name" placeholder="请输入套餐名称（如：基础护理套餐）" maxlength="50">
              </div>
            </div>
          </div>

          <!-- 项目组合区 -->
          <div class="form-section">
            <div class="form-section-title">服务项目组合（支持勾选/拖拽）</div>
            <div class="project-selection">
              <!-- 左侧可选项目 -->
              <div class="project-panel">
                <div class="panel-title">可选服务项目（平台配置）</div>
                <div class="project-list" id="source-projects">
                  <!-- 服务项目将通过JavaScript动态加载 -->
                </div>
              </div>

              <!-- 右侧已选项目 -->
              <div class="project-panel">
                <div class="panel-title">已选服务项目</div>
                <div class="project-list" id="target-projects">
                  <!-- 已选项目动态生成 -->
                </div>
                <div class="project-actions">
                  <button class="btn btn-xs btn-outline-secondary" onclick="moveProject('up')" disabled id="btn-up">
                    <i class="fa fa-arrow-up"></i> 上移
                  </button>
                  <button class="btn btn-xs btn-outline-secondary" onclick="moveProject('down')" disabled id="btn-down">
                    <i class="fa fa-arrow-down"></i> 下移
                  </button>
                  <button class="btn btn-xs btn-outline-secondary" onclick="removeSelectedProject()" disabled id="btn-remove">
                    <i class="fa fa-times"></i> 删除选中
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- 时长设置区 -->
          <div class="form-section">
            <div class="form-section-title">套餐时长设置</div>
            <div class="duration-wrap">
              <div class="flex-grow-0">
                <label class="form-label mb-1">已选项目总时长：</label>
                <input type="text" class="form-control readonly-input" id="total-project-duration" value="0分钟" readonly>
                <div class="tip-text">根据所选服务项目的单次时长自动计算</div>
              </div>
              <div class="flex-grow-0">
                <label class="form-label mb-1">套餐总时长（分钟）<span class="text-danger">*</span>：</label>
                <input type="number" class="form-control" id="package-duration" placeholder="自动计算" min="1" onchange="onPackageDurationChange()" onfocus="this.dataset.manual = 'true'">
                <div class="tip-text">提示：自动计算为项目总时长的90%（考虑项目间衔接效率），可手动调整</div>
              </div>
            </div>
          </div>

          <!-- 底部操作按钮 -->
          <div class="bottom-actions">
            <button class="btn btn-outline-secondary" onclick="backToListPage()">返回</button>
            <button class="btn btn-primary" onclick="savePackage()">保存套餐</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 通知模态框 -->
  <div class="modal fade" id="notificationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="fa fa-bell-o"></i> 系统通知
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="notificationList">
            <!-- 通知列表将通过JavaScript动态生成 -->
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
          <button type="button" class="btn btn-primary" id="markAllReadBtn">全部标记为已读</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // 全局变量
    let currentPackageId = '';
    let editType = ''; // add/edit/copy
    
    // 服务项目数据（平台配置，从数据库service_item表获取）
    const serviceItems = [
      {id: 1, item_name: '整理床单位', work_time: 5, maxnum_perweek: null, gender_limit: null},
      {id: 2, item_name: '更换被单', work_time: 15, maxnum_perweek: 1, gender_limit: null},
      {id: 3, item_name: '面部清洁', work_time: 5, maxnum_perweek: null, gender_limit: null},
      {id: 4, item_name: '梳头', work_time: 5, maxnum_perweek: null, gender_limit: '女'},
      {id: 5, item_name: '理发/剪发', work_time: 15, maxnum_perweek: 1, gender_limit: null},
      {id: 6, item_name: '剃须', work_time: 5, maxnum_perweek: null, gender_limit: '男'},
      {id: 7, item_name: '口腔清洁/护理', work_time: 15, maxnum_perweek: null, gender_limit: null},
      {id: 8, item_name: '洗发', work_time: 20, maxnum_perweek: 2, gender_limit: null},
      {id: 9, item_name: '指/趾甲护理', work_time: 5, maxnum_perweek: 2, gender_limit: null},
      {id: 10, item_name: '手足清洁/护理', work_time: 15, maxnum_perweek: null, gender_limit: null},
      {id: 11, item_name: '耳部护理', work_time: 15, maxnum_perweek: null, gender_limit: null},
      {id: 12, item_name: '温水擦浴(床上擦浴)', work_time: 20, maxnum_perweek: null, gender_limit: null},
      {id: 13, item_name: '淋浴(盆浴、淋浴)', work_time: 20, maxnum_perweek: null, gender_limit: null},
      {id: 14, item_name: '洗澡机淋浴', work_time: 20, maxnum_perweek: null, gender_limit: null},
      {id: 15, item_name: '协助更衣(更换上衣/裤子)', work_time: 5, maxnum_perweek: null, gender_limit: null},
      {id: 16, item_name: '会阴清洁/护理', work_time: 15, maxnum_perweek: null, gender_limit: null},
      {id: 17, item_name: '协助进食/水', work_time: 20, maxnum_perweek: null, gender_limit: null},
      {id: 18, item_name: '床上进食', work_time: 20, maxnum_perweek: null, gender_limit: null},
      {id: 19, item_name: '鼻饲', work_time: 20, maxnum_perweek: null, gender_limit: null},
      {id: 20, item_name: '协助如厕', work_time: 10, maxnum_perweek: null, gender_limit: null},
      {id: 21, item_name: '尿垫、纸尿裤更换', work_time: 5, maxnum_perweek: null, gender_limit: null},
      {id: 22, item_name: '失禁护理', work_time: 8, maxnum_perweek: null, gender_limit: null},
      {id: 23, item_name: '床上使用便器', work_time: 10, maxnum_perweek: null, gender_limit: null},
      {id: 24, item_name: '开塞露通便', work_time: 15, maxnum_perweek: null, gender_limit: null},
      {id: 25, item_name: '人工取便', work_time: 20, maxnum_perweek: null, gender_limit: null},
      {id: 26, item_name: '集尿袋更换', work_time: 5, maxnum_perweek: null, gender_limit: null},
      {id: 27, item_name: '人工肛门便袋护理', work_time: 5, maxnum_perweek: null, gender_limit: null},
      {id: 28, item_name: '翻身叩背排痰', work_time: 10, maxnum_perweek: null, gender_limit: null},
      {id: 29, item_name: '协助床上移动', work_time: 5, maxnum_perweek: null, gender_limit: null},
      {id: 30, item_name: '借助器具移动(含协助轮椅转移)', work_time: 5, maxnum_perweek: null, gender_limit: null},
      {id: 31, item_name: '协助床椅转移', work_time: 5, maxnum_perweek: null, gender_limit: null},
      {id: 32, item_name: '冰袋使用', work_time: 35, maxnum_perweek: null, gender_limit: null},
      {id: 33, item_name: '冷湿敷', work_time: 15, maxnum_perweek: null, gender_limit: null},
      {id: 34, item_name: '温水乙醇擦浴', work_time: 20, maxnum_perweek: null, gender_limit: null},
      {id: 35, item_name: '压力性损伤预防护理', work_time: 15, maxnum_perweek: null, gender_limit: null},
      {id: 36, item_name: '关节活动练习', work_time: 8, maxnum_perweek: null, gender_limit: null},
      {id: 37, item_name: '生活自理能力训练', work_time: 20, maxnum_perweek: null, gender_limit: null},
      {id: 38, item_name: '安全保护带使用', work_time: 10, maxnum_perweek: null, gender_limit: null},
      {id: 39, item_name: '生命体征检测(T、P、R)', work_time: 15, maxnum_perweek: null, gender_limit: null},
      {id: 40, item_name: '吸氧', work_time: 10, maxnum_perweek: null, gender_limit: null},
      {id: 41, item_name: '药物管理', work_time: 15, maxnum_perweek: null, gender_limit: null},
      {id: 42, item_name: '口服给药', work_time: 5, maxnum_perweek: null, gender_limit: null}
    ];
    
    // 初始化服务项目列表（优化性能）
    function initServiceItems() {
      const sourceList = document.getElementById('source-projects');
      if (!sourceList) return; // 如果元素不存在，直接返回
      
      sourceList.innerHTML = '';
      
      // 使用DocumentFragment批量添加DOM，减少重排和重绘
      const fragment = document.createDocumentFragment();
      
      serviceItems.forEach(item => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'project-item';
        itemDiv.setAttribute('data-id', item.id);
        itemDiv.setAttribute('data-duration', item.work_time);
        itemDiv.setAttribute('data-gender-limit', item.gender_limit || '');
        
        const genderBadge = item.gender_limit 
          ? `<span class="gender-badge ${item.gender_limit === '男' ? 'male' : 'female'}">${item.gender_limit}</span>`
          : '';
        const maxWeekText = item.maxnum_perweek 
          ? `<span style="color: #999; font-size: 11px;">每周最多${item.maxnum_perweek}次</span>`
          : '';
        
        itemDiv.innerHTML = `
          <input type="checkbox" class="form-check-input me-2" onclick="toggleProject(this)">
          <div class="project-info">
            <div class="project-name">${item.item_name}${genderBadge}</div>
            <div class="project-meta">${maxWeekText}</div>
          </div>
          <div class="project-duration">${item.work_time}分钟</div>
        `;
        
        fragment.appendChild(itemDiv);
      });
      
      // 一次性添加到DOM
      sourceList.appendChild(fragment);
    }

    // 立即初始化服务项目列表（不等待window.onload）
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        initServiceItems();
      });
    } else {
      // DOM已经加载完成，立即初始化
      initServiceItems();
    }
    
    // 初始化拖拽功能（Sortable.js）
    window.onload = function() {
      // 确保服务项目列表已初始化
      initServiceItems();
      
      // 已选项目列表拖拽排序（延迟初始化，等待DOM完全加载）
      setTimeout(function() {
        const targetList = document.getElementById('target-projects');
        if (targetList) {
          targetList.sortableInstance = new Sortable(targetList, {
            animation: 150,
            ghostClass: 'bg-light',
            onEnd: function() {
              calculateTotalDuration(); // 排序后重新计算时长
            }
          });

          // 监听已选项目选中状态，控制操作按钮
          // 注意：这个事件监听器在openEditPage中也会设置，这里作为备用
          targetList.addEventListener('click', function(e) {
            const clickedItem = e.target.closest('.project-item');
            if (clickedItem) {
              // 点击项目区域时，切换选中状态
              const items = targetList.querySelectorAll('.project-item');
              if (clickedItem.classList.contains('selected')) {
                // 如果已选中，点击后取消选中（但项目不消失）
                clickedItem.classList.remove('selected');
                updateActionButtons(true);
              } else {
                // 如果未选中，点击后选中
                items.forEach(item => item.classList.remove('selected'));
                clickedItem.classList.add('selected');
                updateActionButtons();
              }
            }
          });
        }
      }, 100);
    };

    // 套餐列表查询
    function queryPackage() {
      // 实际项目中调用接口查询，此处仅做演示
      const name = document.getElementById('filter-name').value;
      const duration = document.getElementById('filter-duration').value;
      const status = document.getElementById('filter-status').value;
      console.log('查询条件：', {name, duration, status});
      // alert('查询条件：名称=' + name + '，时长=' + duration + '，状态=' + status);
    }

    // 重置筛选条件
    function resetFilter() {
      document.getElementById('filter-name').value = '';
      document.getElementById('filter-duration').value = '';
      document.getElementById('filter-status').value = '';
    }

    // 切换套餐状态（启用/禁用）
    function changeStatus(id, status) {
      const statusText = status === 'enabled' ? '启用' : '禁用';
      if (confirm(`确认${statusText}该套餐吗？`)) {
        // 实际项目中调用接口更新状态
        alert(`套餐${statusText}成功！`);
        // 刷新列表（示例）
        const row = document.querySelector(`#package-table-body tr:nth-child(${id}) td:nth-child(6) span`);
        if (status === 'enabled') {
          row.className = 'badge status-enabled';
          row.textContent = '启用';
        } else {
          row.className = 'badge status-disabled';
          row.textContent = '禁用';
        }
      }
    }

    // 打开编辑页（新增/编辑/复制）
    function openEditPage(type, id = '') {
      editType = type;
      currentPackageId = id;
      
      // 切换页面显示
      document.getElementById('list-page').style.display = 'none';
      document.getElementById('edit-page').style.display = 'block';

      // 确保服务项目列表已初始化（解决延迟问题）
      initServiceItems();
      
      // 初始化拖拽功能（如果还未初始化）
      const targetList = document.getElementById('target-projects');
      if (targetList && !targetList.sortableInstance) {
        targetList.sortableInstance = new Sortable(targetList, {
          animation: 150,
          ghostClass: 'bg-light',
          onEnd: function() {
            calculateTotalDuration(); // 排序后重新计算时长
          }
        });
        
        // 监听已选项目选中状态，控制操作按钮
        // 注意：每个项目都有自己的点击事件，这里作为全局备用
        targetList.addEventListener('click', function(e) {
          const clickedItem = e.target.closest('.project-item');
          if (clickedItem) {
            // 点击项目区域时，切换选中状态
            const items = targetList.querySelectorAll('.project-item');
            if (clickedItem.classList.contains('selected')) {
              // 如果已选中，点击后取消选中（但项目不消失）
              clickedItem.classList.remove('selected');
              updateActionButtons(true);
            } else {
              // 如果未选中，点击后选中
              items.forEach(item => item.classList.remove('selected'));
              clickedItem.classList.add('selected');
              updateActionButtons();
            }
          }
        });
      }

      // 重置编辑表单
      resetEditForm();

      // 设置标题
      if (type === 'add') {
        document.getElementById('edit-title').textContent = '新增服务套餐';
      } else if (type === 'edit') {
        document.getElementById('edit-title').textContent = '编辑服务套餐';
        // 加载套餐数据（示例）
        loadPackageData(id);
      } else if (type === 'copy') {
        document.getElementById('edit-title').textContent = '复制服务套餐';
        // 加载套餐数据并修改名称
        loadPackageData(id, true);
      }
    }

    // 返回列表页
    function backToListPage() {
      document.getElementById('edit-page').style.display = 'none';
      document.getElementById('list-page').style.display = 'block';
    }

    // 重置编辑表单
    function resetEditForm() {
      document.getElementById('package-name').value = '';
      document.getElementById('package-duration').value = '';
      document.getElementById('total-project-duration').value = '0分钟';
      
      // 重置手动修改标记
      const durationInput = document.getElementById('package-duration');
      durationInput.dataset.manual = 'false';
      durationInput.style.borderColor = '#ddd';
      durationInput.title = '';
      
      // 清空已选项目
      document.getElementById('target-projects').innerHTML = '';
      
      // 重置可选项目勾选状态
      const sourceItems = document.getElementById('source-projects').querySelectorAll('.project-item');
      sourceItems.forEach(item => {
        item.querySelector('input').checked = false;
        item.classList.remove('selected');
      });
      
      // 禁用操作按钮
      updateActionButtons(true);
    }

    // 加载套餐数据（编辑/复制）
    function loadPackageData(id, isCopy = false) {
      // 模拟接口返回数据
      let packageData = {};
      if (id == 1) {
        packageData = {
          name: '基础护理套餐',
          duration: 180,
          projects: [1, 2, 3, 4, 5, 6, 7, 8] // 已选项目ID
        };
      } else if (id == 2) {
        packageData = {
          name: '重度失能护理套餐',
          duration: 240,
          projects: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12]
        };
      } else if (id == 3) {
        packageData = {
          name: '康复护理套餐',
          duration: 120,
          projects: [36, 37, 35]
        };
      }

      // 填充表单
      document.getElementById('package-name').value = isCopy ? packageData.name + '（副本）' : packageData.name;
      const durationInput = document.getElementById('package-duration');
      durationInput.value = packageData.duration;
      // 编辑模式下，标记为手动设置（因为是从数据库加载的值）
      durationInput.dataset.manual = 'true';

      // 勾选并添加已选项目（优化性能）
      const sourceItems = document.getElementById('source-projects').querySelectorAll('.project-item');
      const targetList = document.getElementById('target-projects');
      const fragment = document.createDocumentFragment();
      
      packageData.projects.forEach(projId => {
        const item = Array.from(sourceItems).find(el => parseInt(el.dataset.id) === projId);
        if (item) {
          item.querySelector('input').checked = true;
          item.classList.add('selected');
          // 复制到已选列表
          const clone = item.cloneNode(true);
          // 移除右侧项目的checkbox（右边不需要勾选框）
          const checkboxInClone = clone.querySelector('input[type="checkbox"]');
          if (checkboxInClone) {
            checkboxInClone.remove();
          }
          clone.classList.remove('selected');
          
          // 添加点击事件：右边点击选中/取消选中（只改变高亮状态，不删除项目）
          clone.addEventListener('click', function(e) {
            // 点击项目区域时，切换选中状态
            const items = targetList.querySelectorAll('.project-item');
            if (this.classList.contains('selected')) {
              // 如果已选中，点击后取消选中（但项目不消失）
              this.classList.remove('selected');
              updateActionButtons(true);
            } else {
              // 如果未选中，点击后选中
              items.forEach(i => i.classList.remove('selected'));
              this.classList.add('selected');
              updateActionButtons();
            }
          });
          
          fragment.appendChild(clone);
        }
      });
      
      // 一次性添加到DOM
      targetList.appendChild(fragment);

      // 计算已选项目总时长
      calculateTotalDuration();
    }

    // 勾选/取消项目（左侧→右侧）
    function toggleProject(checkbox) {
      const item = checkbox.closest('.project-item');
      const targetList = document.getElementById('target-projects');
      const itemId = item.dataset.id;

      if (checkbox.checked) {
        // 1. 左边勾选，右边出现
        // 选中：添加到已选列表（如果已存在则不重复添加）
        const existingItem = targetList.querySelector(`.project-item[data-id="${itemId}"]`);
        if (existingItem) {
          // 如果已存在，只更新勾选状态，不重复添加
          checkbox.checked = true;
          return;
        }
        
        // 克隆项目到右侧，但移除checkbox
        const clone = item.cloneNode(true);
        // 移除右侧项目的checkbox（右边不需要勾选框）
        const checkboxInClone = clone.querySelector('input[type="checkbox"]');
        if (checkboxInClone) {
          checkboxInClone.remove();
        }
        clone.classList.remove('selected'); // 初始不选中
        clone.setAttribute('data-source-id', itemId); // 标记来源
        
        // 添加点击事件：右边点击选中/取消选中（只改变高亮状态，不删除项目）
        clone.addEventListener('click', function(e) {
          // 点击项目区域时，切换选中状态
          const items = targetList.querySelectorAll('.project-item');
          if (this.classList.contains('selected')) {
            // 如果已选中，点击后取消选中（但项目不消失）
            this.classList.remove('selected');
            updateActionButtons(true);
          } else {
            // 如果未选中，点击后选中
            items.forEach(i => i.classList.remove('selected'));
            this.classList.add('selected');
            updateActionButtons();
          }
        });
        
        targetList.appendChild(clone);
        
        // 计算总时长
        calculateTotalDuration();
      } else {
        // 2. 左边取消勾选，右边消失
        item.classList.remove('selected');
        
        // 查找并移除右侧对应的项目
        const targetItem = targetList.querySelector(`.project-item[data-id="${itemId}"]`);
        if (targetItem) {
          targetItem.remove();
          // 重新计算总时长
          calculateTotalDuration();
          // 更新操作按钮状态
          updateActionButtons(true);
        }
      }
    }
    
    // 更新操作按钮状态
    function updateActionButtons(disable = false) {
      const targetList = document.getElementById('target-projects');
      const hasSelected = !disable && targetList.querySelector('.project-item.selected') !== null;
      document.getElementById('btn-up').disabled = !hasSelected;
      document.getElementById('btn-down').disabled = !hasSelected;
      document.getElementById('btn-remove').disabled = !hasSelected;
    }

    // 调整已选项目顺序（上移/下移）
    function moveProject(direction) {
      const targetList = document.getElementById('target-projects');
      const selectedItem = targetList.querySelector('.project-item.selected');
      if (!selectedItem) return;

      const siblings = Array.from(targetList.children);
      const index = siblings.indexOf(selectedItem);

      if (direction === 'up' && index > 0) {
        targetList.insertBefore(selectedItem, siblings[index - 1]);
      } else if (direction === 'down' && index < siblings.length - 1) {
        targetList.insertBefore(selectedItem, siblings[index + 1].nextSibling);
      }
    }

    // 移除选中的已选项目
    function removeSelectedProject() {
      const targetList = document.getElementById('target-projects');
      const selectedItem = targetList.querySelector('.project-item.selected');
      if (!selectedItem) return;

      const itemId = selectedItem.dataset.id;
      
      // 3. 右边勾选后点击删除，右边消失且左边取消勾选
      // 取消左侧对应项目的勾选
      const sourceItem = document.querySelector(`#source-projects .project-item[data-id="${itemId}"]`);
      if (sourceItem) {
        sourceItem.querySelector('input').checked = false;
        sourceItem.classList.remove('selected');
      }

      // 移除已选项目
      selectedItem.remove();

      // 计算总时长
      calculateTotalDuration();

      // 禁用操作按钮
      updateActionButtons(true);
    }

    // 计算已选项目总时长并自动设置套餐时长
    function calculateTotalDuration() {
      const targetItems = document.getElementById('target-projects').querySelectorAll('.project-item');
      let total = 0;
      targetItems.forEach(item => {
        total += parseInt(item.dataset.duration);
      });
      document.getElementById('total-project-duration').value = total + '分钟';
      
      // 自动计算套餐时长（项目总时长的90%，四舍五入）
      const durationInput = document.getElementById('package-duration');
      // 如果用户没有手动修改过，则自动计算
      if (!durationInput.dataset.manual || durationInput.dataset.manual !== 'true') {
        const autoDuration = Math.round(total * 0.9);
        durationInput.value = autoDuration > 0 ? autoDuration : '';
      }
      
      // 验证套餐时长是否合理
      validatePackageDuration();
    }
    
    // 套餐时长手动修改时的处理
    function onPackageDurationChange() {
      const durationInput = document.getElementById('package-duration');
      durationInput.dataset.manual = 'true';
      validatePackageDuration();
    }
    
    // 验证套餐时长
    function validatePackageDuration() {
      const totalDuration = parseInt(document.getElementById('total-project-duration').value) || 0;
      const packageDuration = parseInt(document.getElementById('package-duration').value) || 0;
      
      if (packageDuration > 0 && totalDuration > 0) {
        const durationInput = document.getElementById('package-duration');
        if (packageDuration > totalDuration * 1.2) {
          durationInput.style.borderColor = '#ff9800';
          durationInput.title = '套餐时长明显大于项目总时长，请确认是否合理';
        } else if (packageDuration < totalDuration * 0.5) {
          durationInput.style.borderColor = '#ff9800';
          durationInput.title = '套餐时长明显小于项目总时长，请确认是否合理';
        } else {
          durationInput.style.borderColor = '#ddd';
          durationInput.title = '';
        }
      } else if (packageDuration > 0) {
        const durationInput = document.getElementById('package-duration');
        durationInput.style.borderColor = '#ddd';
        durationInput.title = '';
      }
    }

    // 保存套餐
    function savePackage() {
      // 表单校验
      const name = document.getElementById('package-name').value.trim();
      const duration = parseInt(document.getElementById('package-duration').value);
      const projectCount = document.getElementById('target-projects').children.length;
      const totalDuration = parseInt(document.getElementById('total-project-duration').value);

      if (!name) {
        alert('请输入套餐名称！');
        return;
      }
      if (name.length > 50) {
        alert('套餐名称不能超过50个字符！');
        return;
      }
      if (projectCount === 0) {
        alert('请至少选择一项服务项目！');
        return;
      }
      if (!duration || duration <= 0) {
        alert('请输入有效的套餐总时长！');
        return;
      }
      if (duration > totalDuration) {
        if (!confirm(`套餐总时长(${duration}分钟)大于已选项目总时长(${totalDuration}分钟)，是否继续保存？`)) {
          return;
        }
      }

      // 获取已选项目ID列表
      const selectedProjects = [];
      const targetItems = document.getElementById('target-projects').querySelectorAll('.project-item');
      targetItems.forEach(item => {
        selectedProjects.push(parseInt(item.dataset.id));
      });

      // 构造提交数据
      const packageData = {
        id: currentPackageId,
        name: name,
        duration: duration,
        projectIds: selectedProjects,
        projectCount: projectCount,
        totalProjectDuration: totalDuration,
        type: editType
      };

      // 实际项目中调用接口保存
      console.log('保存套餐数据:', packageData);
      alert(`套餐保存成功！\n套餐名称：${name}\n套餐时长：${duration}分钟\n包含项目：${projectCount}项`);
      
      // 返回列表页
      backToListPage();
    }
    
    // ========== 通知功能 ==========
    // 通知数据
    let notifications = [
      { id: 1, title: '套餐更新', content: '套餐配置已保存成功。', time: '2025-12-10 14:30:25', read: false, type: 'success' },
      { id: 2, title: '系统维护通知', content: '系统将于今晚22:00-24:00进行维护，期间可能无法访问。', time: '2025-12-10 10:15:00', read: false, type: 'warning' },
      { id: 3, title: '套餐推荐', content: '有3个新套餐可供选择，请查看。', time: '2025-12-09 09:00:00', read: false, type: 'info' }
    ];
    
    // 通知按钮点击事件
    $('.notification').click(function() {
      renderNotifications();
      const notificationModal = new bootstrap.Modal('#notificationModal');
      notificationModal.show();
    });
    
    // 渲染通知列表
    function renderNotifications() {
      const notificationList = $('#notificationList');
      if (notificationList.length === 0) return;
      
      notificationList.empty();
      
      const unreadCount = notifications.filter(n => !n.read).length;
      $('.notification-badge').text(unreadCount > 0 ? unreadCount : '');
      $('.notification-badge').toggle(unreadCount > 0);
      
      if (notifications.length === 0) {
        notificationList.html('<div class="text-center text-muted py-4">暂无通知</div>');
        return;
      }
      
      notifications.forEach(notif => {
        const typeClass = {
          'success': 'text-success',
          'warning': 'text-warning',
          'info': 'text-info',
          'error': 'text-danger'
        }[notif.type] || 'text-info';
        
        const iconClass = {
          'success': 'fa-check-circle',
          'warning': 'fa-exclamation-circle',
          'info': 'fa-info-circle',
          'error': 'fa-times-circle'
        }[notif.type] || 'fa-info-circle';
        
        notificationList.append(`
          <div class="notification-item p-3 mb-2 border rounded ${notif.read ? '' : 'bg-light'}" data-id="${notif.id}">
            <div class="d-flex justify-content-between align-items-start">
              <div class="flex-grow-1">
                <div class="d-flex align-items-center mb-1">
                  <i class="fa ${iconClass} ${typeClass} me-2"></i>
                  <strong class="${notif.read ? '' : 'fw-bold'}">${notif.title}</strong>
                  ${!notif.read ? '<span class="badge bg-danger ms-2">未读</span>' : ''}
                </div>
                <p class="text-muted mb-1 small">${notif.content}</p>
                <small class="text-muted">${notif.time}</small>
              </div>
              ${!notif.read ? '<button class="btn btn-sm btn-link mark-read-btn" data-id="' + notif.id + '">标记已读</button>' : ''}
            </div>
          </div>
        `);
      });
    }
    
    // 标记单个通知为已读
    $(document).on('click', '.mark-read-btn', function() {
      const id = parseInt($(this).data('id'));
      const notif = notifications.find(n => n.id === id);
      if (notif) {
        notif.read = true;
        renderNotifications();
      }
    });
    
    // 全部标记为已读
    $(document).on('click', '#markAllReadBtn', function() {
      notifications.forEach(n => n.read = true);
      renderNotifications();
    });
    
    // 初始化通知显示
    renderNotifications();
  </script>
</body>
</html>
