<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>服务对象综合查询 - 居家长护业务管理系统</title>
  <!-- 引入外部资源 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <style>
    /* 继承全局样式 */
    body { font-family: "微软雅黑", "思源黑体", sans-serif; background-color: #f5f7fa; color: #333; }
    .btn-primary { background-color: #1890FF; border-color: #1890FF; }
    .btn-primary:hover { background-color: #096DD9; border-color: #096DD9; }
    .btn-outline-secondary { border-color: #ddd; color: #666; }
    .btn-outline-secondary:hover { background-color: #f5f5f5; border-color: #ccc; }
    .btn-danger { background-color: #FF4D4F; border-color: #FF4D4F; }
    .btn-danger:hover { background-color: #F5222D; border-color: #F5222D; }
    .card { border: none; border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,0.08); margin-bottom: 20px; }
    .card-header { background: #fff; border-bottom: 1px solid #f0f0f0; border-radius: 12px 12px 0 0; padding: 15px 20px; font-weight: 600; font-size: 15px; }
    .card-body { padding: 20px; }
    /* 布局样式 */
    .app-container { display: flex; min-height: 100vh; }
    /* 侧边导航 */
    .sidebar { width: 220px; background: #fff; box-shadow: 1px 0 2px rgba(0,0,0,0.05); padding: 20px 0; flex-shrink: 0; }
    .sidebar-logo { text-align: center; padding: 0 20px 20px; border-bottom: 1px solid #f0f0f0; margin-bottom: 20px; }
    .sidebar-logo img { height: 40px; margin-bottom: 8px; }
    .sidebar-logo h3 { font-size: 16px; color: #1890FF; font-weight: 600; margin: 0; }
    .nav-menu { list-style: none; padding: 0; margin: 0; }
    .nav-item { margin-bottom: 4px; }
    .nav-link { display: flex; align-items: center; padding: 12px 20px; color: #666; text-decoration: none; font-size: 14px; border-left: 3px solid transparent; }
    .nav-link:hover, .nav-link.active { color: #1890FF; background-color: #f0f7ff; border-left: 3px solid #1890FF; }
    .nav-link i { font-size: 18px; margin-right: 12px; width: 20px; text-align: center; }
    .nav-group-title { padding: 15px 20px 5px; font-size: 12px; color: #999; font-weight: 500; }
    /* 主内容区 */
    .main-content { flex: 1; padding: 20px; overflow-y: auto; }
    /* 顶部导航 */
    .top-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .page-title { font-size: 20px; font-weight: 600; color: #333; margin: 0; }
    .user-info { display: flex; align-items: center; }
    .notification { position: relative; margin-right: 20px; cursor: pointer; }
    .notification i { font-size: 20px; color: #666; }
    .notification-badge { position: absolute; top: -5px; right: -5px; width: 18px; height: 18px; background: #FF4D4F; color: #fff; border-radius: 50%; font-size: 12px; text-align: center; line-height: 18px; }
    .user-avatar { width: 40px; height: 40px; border-radius: 50%; background: #1890FF; color: #fff; display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: 600; margin-right: 10px; }
    .user-name { font-size: 14px; font-weight: 500; }
    
    /* 查询页面专属样式 */
    .filter-section { background: #fff; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .filter-row { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 15px; align-items: flex-end; }
    .filter-row:last-child { margin-bottom: 0; }
    .filter-item { flex: 1; min-width: 200px; display: flex; align-items: center; }
    .filter-label { font-weight: 500; margin-right: 10px; white-space: nowrap; min-width: 80px; font-size: 14px; }
    .form-control, .form-select { border-radius: 6px; border: 1px solid #ddd; font-size: 14px; }
    .btn-filter { background: #1890FF; color: #fff; border: none; padding: 8px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; }
    .btn-filter:hover { background: #096DD9; }
    .btn-reset { background: #fff; color: #666; border: 1px solid #ddd; padding: 8px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; }
    .btn-reset:hover { background: #f5f5f5; border-color: #ccc; }
    .filter-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 10px; }
    
    .data-table { background: #fff; border-radius: 8px; overflow: hidden; margin-bottom: 20px; }
    .table-header { background: #f8f9fa; padding: 12px 20px; font-weight: 600; border-bottom: 1px solid #f0f0f0; }
    .table-responsive { max-height: 400px; overflow-y: auto; }
    .table th, .table td { vertical-align: middle; padding: 12px 20px; border-bottom: 1px solid #f0f0f0; }
    .table th { background: #f8f9fa; font-weight: 500; }
    .table tbody tr:hover { background: #f9f9f9; }
    .checkbox-all { margin-right: 5px; }
    .text-danger { color: #FF4D4F !important; }
    .badge-warning { background-color: #FFF7E6; color: #FAAD14; padding: 3px 6px; border-radius: 4px; font-size: 12px; }
    .status-badge { display: inline-block; padding: 3px 8px; border-radius: 12px; font-size: 12px; font-weight: 500; }
    .status-normal { background-color: #E6F7E6; color: #52C41A; }
    .status-pause { background-color: #FFF7E6; color: #FAAD14; }
    .status-transfer { background-color: #E6F7FF; color: #1890FF; }
    .status-death { background-color: #FFE6E6; color: #FF4D4F; }
    
    .action-section { background: #fff; padding: 15px 20px; border-radius: 8px; display: flex; flex-wrap: wrap; align-items: center; gap: 15px; justify-content: space-between; }
    .template-selector { flex: 1; min-width: 250px; }
    .btn-action { padding: 8px 20px; border-radius: 6px; font-weight: 500; cursor: pointer; }
    .btn-validate { background: #1890FF; color: #fff; border: none; }
    .btn-validate:hover { background: #096DD9; }
    .btn-export { background: #52C41A; color: #fff; border: none; }
    .btn-export:hover { background: #41A819; }
    .btn-disabled { background: #ccc; cursor: not-allowed; }
    .btn-disabled:hover { background: #ccc; }
    
    .export-log { margin-top: 30px; }
    .log-header { font-weight: 600; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
    .log-table { background: #fff; border-radius: 8px; overflow: hidden; }
    
    /* 模态框样式 */
    .modal-header { border-bottom: 1px solid #f0f0f0; }
    .modal-title { font-weight: 600; }
    .modal-body { max-height: 500px; overflow-y: auto; }
    .validation-result { margin-bottom: 15px; }
    .result-stats { display: flex; gap: 20px; margin-bottom: 15px; }
    .stat-item { display: flex; align-items: center; }
    .stat-icon { width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 8px; font-size: 12px; color: #fff; }
    .stat-success { background-color: #52C41A; }
    .stat-fail { background-color: #FF4D4F; }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- 侧边导航 -->
    <div class="sidebar">
      <div class="sidebar-logo">
          <img src="https://via.placeholder.com/80x40?text=居家长护" alt="系统Logo">
          <h3>管理员工作平台</h3>
      </div>
      
      <!-- 导航分组：系统配置 -->
      <div class="nav-group-title">系统配置</div>
      <ul class="nav-menu">
          <li class="nav-item">
              <a href="机构信息配置.html" class="nav-link">
                  <i class="fa fa-building-o"></i>
                  <span>机构信息配置</span>
              </a>
          </li>
          <li class="nav-item">
              <a href="套餐管理.html" class="nav-link">
                  <i class="fa fa-cog"></i>
                  <span>套餐管理</span>
              </a>
          </li>
          <li class="nav-item">
              <a href="行政区划.html" class="nav-link">
                  <i class="fa fa-book"></i>
                  <span>行政区域管理</span>
              </a>
          </li>
      </ul>
      
      <!-- 导航分组：用户管理 -->
      <div class="nav-group-title">用户管理</div>
      <ul class="nav-menu">
          <li class="nav-item">
              <a href="角色配置.html" class="nav-link">
                  <i class="fa fa-user-secret"></i>
                  <span>角色权限配置</span>
              </a>
          </li>
      </ul>
      
      <!-- 导航分组：日志管理 -->
      <div class="nav-group-title">数据管理</div>
      <ul class="nav-menu">
          <li class="nav-item">
              <a href="服务线索批量导入.html" class="nav-link">
                  <i class="fa fa-upload"></i>
                  <span>服务对象数据批量导入</span>
              </a>
          </li>
          <li class="nav-item">
              <a href="服务对象数据维护.html" class="nav-link">
                  <i class="fa fa-edit"></i>
                  <span>服务对象数据维护</span>
              </a>
          </li>
          <li class="nav-item">
              <a href="医保工单导入.html" class="nav-link">
                  <i class="fa fa-file-excel-o"></i>
                  <span>医保平台工单导入</span>
              </a>
          </li>
          <li class="nav-item">
              <a href="医保平台新增服务对象数据.html" class="nav-link active">
                  <i class="fa fa-download"></i>
                  <span>医保平台新增服务对象数据导出</span>
              </a>
          </li>
          <li class="nav-item">
              <a href="医保对账数据管理.html" class="nav-link">
                  <i class="fa fa-calculator"></i>
                  <span>医保对账数据管理</span>
              </a>
          </li>
          <li class="nav-item">
              <a href="关键数据配置.html" class="nav-link">
                  <i class="fa fa-wrench"></i>
                  <span>其他数据维护</span>
              </a>
          </li>
      </ul>
  </div>
    <!-- 主内容区 -->
    <div class="main-content">
      <!-- 顶部导航：标题 + 操作按钮 -->
      <div class="top-nav">
        <h1 class="page-title">服务对象综合查询</h1>
        <div class="user-info">
          <div class="notification">
            <i class="fa fa-bell-o"></i>
            <span class="notification-badge">3</span>
          </div>
          <div class="user-avatar">管</div>
          <div class="user-name">系统管理员</div>
        </div>
      </div>

      <!-- 筛选区域 -->
      <div class="filter-section">
        <div class="filter-row">
          <div class="filter-item">
            <label class="filter-label">姓名：</label>
            <input type="text" id="name" class="form-control" placeholder="支持模糊查询">
          </div>
          <div class="filter-item">
            <label class="filter-label">身份证号：</label>
            <input type="text" id="idCard" class="form-control" placeholder="支持模糊查询">
          </div>
          <div class="filter-item">
            <label class="filter-label">行政区划：</label>
            <select id="region" class="form-select">
              <option value="">全部</option>
              <option value="越城区">越城区</option>
              <option value="柯桥区">柯桥区</option>
              <option value="上虞区">上虞区</option>
              <option value="诸暨市">诸暨市</option>
              <option value="嵊州市">嵊州市</option>
              <option value="新昌县">新昌县</option>
            </select>
          </div>
          <div class="filter-item">
            <label class="filter-label">服务机构：</label>
            <select id="orgName" class="form-select">
              <option value="">全部</option>
              <option value="机构A">机构A</option>
              <option value="机构B">机构B</option>
              <option value="机构C">机构C</option>
            </select>
          </div>
        </div>
        <div class="filter-row">
          <div class="filter-item">
            <label class="filter-label">失能等级：</label>
            <select id="disabilityLevel" class="form-select">
              <option value="">全部</option>
              <option value="重度">重度失能</option>
              <option value="中度">中度失能</option>
              <option value="轻度">轻度失能</option>
            </select>
          </div>
          <div class="filter-item">
            <label class="filter-label">医保类型：</label>
            <select id="medicalType" class="form-select">
              <option value="">全部</option>
              <option value="职工医保">职工医保</option>
              <option value="城乡居民医保">城乡居民医保</option>
            </select>
          </div>
          <div class="filter-item">
            <label class="filter-label">医保绑定状态：</label>
            <select id="medicalStatus" class="form-select">
              <option value="">全部</option>
              <option value="未绑定">未绑定</option>
              <option value="已绑定">已绑定</option>
            </select>
          </div>
          <div class="filter-item">
            <label class="filter-label">服务状态：</label>
            <select id="serviceStatus" class="form-select">
              <option value="">全部</option>
              <option value="正常">正常</option>
              <option value="暂停">暂停</option>
              <option value="转出">转出</option>
              <option value="死亡">死亡</option>
            </select>
          </div>
        </div>
        <div class="filter-row">
          <div class="filter-item">
            <label class="filter-label">公示日期：</label>
            <input type="date" id="publishStartDate" class="form-control" style="width: 140px; display: inline-block;">
            <span style="margin: 0 5px;">至</span>
            <input type="date" id="publishEndDate" class="form-control" style="width: 140px; display: inline-block;">
          </div>
          <div class="filter-item">
            <label class="filter-label">创建日期：</label>
            <input type="date" id="createStartDate" class="form-control" style="width: 140px; display: inline-block;">
            <span style="margin: 0 5px;">至</span>
            <input type="date" id="createEndDate" class="form-control" style="width: 140px; display: inline-block;">
          </div>
          <div class="filter-item">
            <label class="filter-label">联系电话：</label>
            <input type="text" id="phone" class="form-control" placeholder="支持模糊查询">
          </div>
          <div class="filter-item"></div>
        </div>
        <div class="filter-actions">
          <button id="queryBtn" class="btn-filter">
            <i class="fa fa-search"></i> 查询
          </button>
          <button id="resetBtn" class="btn-reset">
            <i class="fa fa-refresh"></i> 重置
          </button>
        </div>
      </div>

      <!-- 数据列表区域 -->
      <div class="data-table">
        <div class="table-header">
          <label>
            <input type="checkbox" id="checkAll" class="checkbox-all">
            <span>全选</span>
          </label>
          <span style="margin-left: 10px;">共 <strong id="totalCount">0</strong> 条数据</span>
        </div>
        <div class="table-responsive">
          <table class="table">
            <thead>
              <tr>
                <th style="width: 60px;">选择</th>
                <th>姓名</th>
                <th>身份证号</th>
                <th>性别</th>
                <th>年龄</th>
                <th>联系电话</th>
                <th>行政区划</th>
                <th>服务机构</th>
                <th>失能等级</th>
                <th>医保类型</th>
                <th>医保绑定</th>
                <th>服务状态</th>
                <th>公示日期</th>
                <th>创建日期</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody id="dataList">
              <!-- 数据将通过JavaScript动态生成 -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- 操作区域 -->
      <div class="action-section">
        <div class="template-selector">
          <label class="filter-label">导出模板：</label>
          <select id="regionTemplate" class="form-select" style="width: 220px; display: inline-block;">
            <option value="">请选择导出模板（可选）</option>
            <option value="shaoxing">绍兴市 - 批量登记模版</option>
            <option value="hangzhou">杭州市 - 新增对象模版</option>
            <option value="ningbo">宁波市 - 医保导入模版</option>
            <option value="standard">标准格式 - 全部字段</option>
          </select>
        </div>
        <div class="action-buttons">
          <button id="exportAllBtn" class="btn-action btn-export">
            <i class="fa fa-download"></i> 导出全部查询结果
          </button>
          <button id="exportSelectedBtn" class="btn-action btn-export btn-disabled" disabled>
            <i class="fa fa-download"></i> 导出选中数据
          </button>
        </div>
      </div>

      <!-- 导出记录区域 -->
      <div class="export-log">
        <div class="log-header">
          <span>导出历史记录</span>
          <button id="refreshLogBtn" class="btn btn-sm btn-outline-secondary">
            <i class="fa fa-refresh"></i> 刷新
          </button>
        </div>
        <div class="log-table">
          <table class="table">
            <thead>
              <tr>
                <th>导出时间</th>
                <th>导出人</th>
                <th>导出模板</th>
                <th>导出数量</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody id="logList">
              <!-- 导出记录将通过JavaScript动态生成 -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- 校验结果模态框 -->
  <div class="modal fade" id="validationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">数据校验结果</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="validation-result">
            <div class="result-stats">
              <div class="stat-item">
                <span class="stat-icon stat-success"><i class="fa fa-check"></i></span>
                <span>校验通过：<strong id="validateSuccess">0</strong> 条</span>
              </div>
              <div class="stat-item">
                <span class="stat-icon stat-fail"><i class="fa fa-times"></i></span>
                <span>校验失败：<strong id="validateFail">0</strong> 条</span>
              </div>
            </div>
            <div id="failReason" style="display: none;">
              <h6>失败详情：</h6>
              <div class="table-responsive">
                <table class="table table-sm">
                  <thead>
                    <tr>
                      <th>姓名</th>
                      <th>身份证号</th>
                      <th>失败原因</th>
                    </tr>
                  </thead>
                  <tbody id="failList">
                    <!-- 失败详情将通过JavaScript动态生成 -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
          <button id="confirmExportBtn" type="button" class="btn btn-primary" data-bs-dismiss="modal">确认导出</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 提示模态框 -->
  <div class="modal fade" id="promptModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm">
      <div class="modal-content">
        <div class="modal-body text-center py-4">
          <i class="fa fa-info-circle text-primary" style="font-size: 36px; margin-bottom: 15px;"></i>
          <h5 class="modal-title" id="promptTitle">操作提示</h5>
          <p class="text-muted" id="promptMsg">正在处理，请稍后...</p>
        </div>
        <div class="modal-footer justify-content-center">
          <button type="button" class="btn btn-primary" data-bs-dismiss="modal">确定</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 导出中模态框 -->
  <div class="modal fade" id="exportingModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-sm">
      <div class="modal-content">
        <div class="modal-body text-center py-4">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <h5 class="modal-title mt-3">导出中</h5>
          <p class="text-muted" id="exportingMsg">正在生成Excel文件，请不要关闭此窗口...</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // 页面加载完成后初始化
    $(function() {
      // 初始化模态框
      const validationModal = new bootstrap.Modal('#validationModal');
      const promptModal = new bootstrap.Modal('#promptModal');
      const exportingModal = new bootstrap.Modal('#exportingModal');

      // 设置默认日期范围（近1个月）
      const today = new Date();
      const oneMonthAgo = new Date();
      oneMonthAgo.setMonth(today.getMonth() - 1);
      $('#publishStartDate').val(formatDate(oneMonthAgo));
      $('#publishEndDate').val(formatDate(today));

      // 全局变量
      let selectedRows = [];  // 选中的数据行ID
      let validData = [];     // 校验通过的数据
      let allData = [];       // 所有查询到的数据

      // 页面加载时自动查询
      queryData();
      loadExportLogs();

      // 查询按钮点击事件
      $('#queryBtn').click(queryData);
      
      // 重置按钮点击事件
      $('#resetBtn').click(function() {
        // 清空所有筛选条件
        $('#name').val('');
        $('#idCard').val('');
        $('#region').val('');
        $('#orgName').val('');
        $('#disabilityLevel').val('');
        $('#medicalType').val('');
        $('#medicalStatus').val('');
        $('#serviceStatus').val('');
        $('#publishStartDate').val('');
        $('#publishEndDate').val('');
        $('#createStartDate').val('');
        $('#createEndDate').val('');
        $('#phone').val('');
        
        // 重置日期为默认值
        $('#publishStartDate').val(formatDate(oneMonthAgo));
        $('#publishEndDate').val(formatDate(today));
        
        // 重新查询
        queryData();
      });

      // 全选/取消全选
      $('#checkAll').change(function() {
        const isChecked = $(this).prop('checked');
        $('input[name="dataItem"]').prop('checked', isChecked);
        
        // 更新选中的行ID数组
        selectedRows = isChecked ? 
          allData.map(item => item.id) : 
          [];
        
        updateExportButtonStatus();
      });

      // 单个数据行选择
      $(document).on('change', 'input[name="dataItem"]', function() {
        const id = $(this).val();
        const isChecked = $(this).prop('checked');
        
        if (isChecked) {
          if (!selectedRows.includes(id)) {
            selectedRows.push(id);
          }
        } else {
          selectedRows = selectedRows.filter(item => item !== id);
        }
        
        // 更新全选框状态
        const totalItems = $('input[name="dataItem"]').length;
        const checkedItems = $('input[name="dataItem"]:checked').length;
        $('#checkAll').prop('checked', totalItems > 0 && totalItems === checkedItems);
        
        updateExportButtonStatus();
      });

      // 导出全部查询结果按钮点击事件
      $('#exportAllBtn').click(function() {
        if (allData.length === 0) {
          showPrompt('操作提示', '没有可导出的数据！');
          return;
        }
        
        validData = allData;
        startExport();
      });

      // 导出选中数据按钮点击事件
      $('#exportSelectedBtn').click(function() {
        if (selectedRows.length === 0) {
          showPrompt('操作提示', '请至少选择一条数据进行导出！');
          return;
        }
        
        // 获取选中的数据
        const selectedData = allData.filter(item => selectedRows.includes(item.id));
        validData = selectedData;
        startExport();
      });

      // 刷新导出日志按钮点击事件
      $('#refreshLogBtn').click(loadExportLogs);

      // 查看详情按钮点击事件
      $(document).on('click', '.view-detail-btn', function() {
        const id = $(this).data('id');
        const item = allData.find(item => item.id === id);
        
        if (item) {
          const age = item.birthDate ? calculateAge(item.birthDate) : '-';
          const gender = item.gender || '-';
          
          let detailHtml = `
            <div class="row mb-2">
              <div class="col-4"><strong>姓名：</strong></div>
              <div class="col-8">${item.name}</div>
            </div>
            <div class="row mb-2">
              <div class="col-4"><strong>身份证号：</strong></div>
              <div class="col-8">${item.idCard}</div>
            </div>
            <div class="row mb-2">
              <div class="col-4"><strong>性别：</strong></div>
              <div class="col-8">${gender}</div>
            </div>
            <div class="row mb-2">
              <div class="col-4"><strong>年龄：</strong></div>
              <div class="col-8">${age}</div>
            </div>
            <div class="row mb-2">
              <div class="col-4"><strong>联系电话：</strong></div>
              <div class="col-8">${item.phone || '<span class="text-danger">未填写</span>'}</div>
            </div>
            <div class="row mb-2">
              <div class="col-4"><strong>行政区划：</strong></div>
              <div class="col-8">${item.region || '<span class="text-muted">-</span>'}</div>
            </div>
            <div class="row mb-2">
              <div class="col-4"><strong>服务机构：</strong></div>
              <div class="col-8">${item.orgName || '<span class="text-muted">-</span>'}</div>
            </div>
            <div class="row mb-2">
              <div class="col-4"><strong>失能等级：</strong></div>
              <div class="col-8">${item.disabilityLevel}</div>
            </div>
            <div class="row mb-2">
              <div class="col-4"><strong>医保类型：</strong></div>
              <div class="col-8">${item.medicalType || '<span class="text-danger">未填写</span>'}</div>
            </div>
            <div class="row mb-2">
              <div class="col-4"><strong>医保绑定状态：</strong></div>
              <div class="col-8">${item.medicalStatus === '已绑定' ? 
                '<span class="badge" style="background-color: #E6F7E6; color: #52C41A;">已绑定</span>' : 
                '<span class="badge" style="background-color: #FFF1F0; color: #FF4D4F;">未绑定</span>'}</div>
            </div>
            <div class="row mb-2">
              <div class="col-4"><strong>服务状态：</strong></div>
              <div class="col-8">${item.serviceStatus || '正常'}</div>
            </div>
            <div class="row mb-2">
              <div class="col-4"><strong>公示日期：</strong></div>
              <div class="col-8">${item.publishDate || '<span class="text-muted">-</span>'}</div>
            </div>
            <div class="row mb-2">
              <div class="col-4"><strong>创建日期：</strong></div>
              <div class="col-8">${item.createDate || '<span class="text-muted">-</span>'}</div>
            </div>
            <div class="row mb-2">
              <div class="col-4"><strong>居住地址：</strong></div>
              <div class="col-8">${item.address || '<span class="text-danger">未填写</span>'}</div>
            </div>
          `;
          
          // 更新模态框内容并显示
          $('#promptTitle').text('服务对象详情');
          $('#promptMsg').html(detailHtml);
          promptModal.show();
        }
      });

      // 下载历史导出文件按钮点击事件
      $(document).on('click', '.download-log-btn', function() {
        const fileName = $(this).data('file');
        showPrompt('下载中', `正在准备下载文件：${fileName}`);
        
        // 模拟下载延迟
        setTimeout(() => {
          promptModal.hide();
          // 实际项目中触发文件下载：window.location.href = `/api/download/export/${fileName}`;
        }, 1000);
      });

      // 查询数据函数
      function queryData() {
        // 获取筛选条件
        const filters = {
          name: $('#name').val().trim(),
          idCard: $('#idCard').val().trim(),
          region: $('#region').val(),
          orgName: $('#orgName').val(),
          disabilityLevel: $('#disabilityLevel').val(),
          medicalType: $('#medicalType').val(),
          medicalStatus: $('#medicalStatus').val(),
          serviceStatus: $('#serviceStatus').val(),
          publishStartDate: $('#publishStartDate').val(),
          publishEndDate: $('#publishEndDate').val(),
          createStartDate: $('#createStartDate').val(),
          createEndDate: $('#createEndDate').val(),
          phone: $('#phone').val().trim()
        };
        
        // 显示加载提示
        showPrompt('查询中', '正在获取数据，请稍后...');
        
        // 模拟异步查询数据
        setTimeout(() => {
          // 模拟完整数据
          let mockData = [
            { id: '1', name: '张三', idCard: '330602199001011234', gender: '男', birthDate: '1990-01-01',
              disabilityLevel: '重度', medicalType: '职工医保', medicalStatus: '已绑定',
              serviceStatus: '正常', publishDate: '2025-09-15', createDate: '2025-09-10',
              address: '绍兴市越城区XX路123号', phone: '13800138000', region: '越城区', orgName: '机构A' },
            { id: '2', name: '李四', idCard: '330602198505125678', gender: '女', birthDate: '1985-05-12',
              disabilityLevel: '重度', medicalType: '城乡居民医保', medicalStatus: '已绑定',
              serviceStatus: '正常', publishDate: '2025-09-20', createDate: '2025-09-18',
              address: '绍兴市柯桥区XX街道456号', phone: '13900139000', region: '柯桥区', orgName: '机构B' },
            { id: '3', name: '王五', idCard: '330602197808259012', gender: '男', birthDate: '1978-08-25',
              disabilityLevel: '重度', medicalType: '', medicalStatus: '未绑定',
              serviceStatus: '暂停', publishDate: '2025-09-25', createDate: '2025-09-22',
              address: '绍兴市上虞区XX镇789号', phone: '13700137000', region: '上虞区', orgName: '机构A' },
            { id: '4', name: '赵六', idCard: '330602198211303456', gender: '女', birthDate: '1982-11-30',
              disabilityLevel: '中度', medicalType: '职工医保', medicalStatus: '已绑定',
              serviceStatus: '正常', publishDate: '2025-10-05', createDate: '2025-10-01',
              address: '绍兴市诸暨市XX路321号', phone: '13600136000', region: '诸暨市', orgName: '机构C' },
            { id: '5', name: '孙七', idCard: '330602199503187890', gender: '男', birthDate: '1995-03-18',
              disabilityLevel: '重度', medicalType: '城乡居民医保', medicalStatus: '未绑定',
              serviceStatus: '转出', publishDate: '2025-10-10', createDate: '2025-10-08',
              address: '绍兴市嵊州市XX街道654号', phone: '13500135000', region: '嵊州市', orgName: '机构B' },
            { id: '6', name: '周八', idCard: '330602198807224567', gender: '女', birthDate: '1988-07-22',
              disabilityLevel: '轻度', medicalType: '职工医保', medicalStatus: '已绑定',
              serviceStatus: '正常', publishDate: '2025-10-15', createDate: '2025-10-12',
              address: '绍兴市新昌县XX路987号', phone: '13400134000', region: '新昌县', orgName: '机构A' },
            { id: '7', name: '吴九', idCard: '330602199201154321', gender: '男', birthDate: '1992-01-15',
              disabilityLevel: '重度', medicalType: '城乡居民医保', medicalStatus: '已绑定',
              serviceStatus: '正常', publishDate: '2025-10-18', createDate: '2025-10-15',
              address: '绍兴市越城区XX路555号', phone: '13300133000', region: '越城区', orgName: '机构C' },
            { id: '8', name: '郑十', idCard: '330602197512089876', gender: '女', birthDate: '1975-12-08',
              disabilityLevel: '重度', medicalType: '职工医保', medicalStatus: '未绑定',
              serviceStatus: '死亡', publishDate: '2025-09-28', createDate: '2025-09-25',
              address: '绍兴市柯桥区XX街道888号', phone: '13200132000', region: '柯桥区', orgName: '机构B' },
          ];
          
          // 应用筛选条件
          allData = mockData.filter(item => {
            // 姓名模糊匹配
            if (filters.name && !item.name.includes(filters.name)) return false;
            
            // 身份证号模糊匹配
            if (filters.idCard && !item.idCard.includes(filters.idCard)) return false;
            
            // 行政区划精确匹配
            if (filters.region && item.region !== filters.region) return false;
            
            // 服务机构精确匹配
            if (filters.orgName && item.orgName !== filters.orgName) return false;
            
            // 失能等级精确匹配
            if (filters.disabilityLevel && item.disabilityLevel !== filters.disabilityLevel) return false;
            
            // 医保类型精确匹配
            if (filters.medicalType && item.medicalType !== filters.medicalType) return false;
            
            // 医保绑定状态匹配
            if (filters.medicalStatus && item.medicalStatus !== filters.medicalStatus) return false;
            
            // 服务状态匹配
            if (filters.serviceStatus && item.serviceStatus !== filters.serviceStatus) return false;
            
            // 公示日期范围
            if (filters.publishStartDate && item.publishDate < filters.publishStartDate) return false;
            if (filters.publishEndDate && item.publishDate > filters.publishEndDate) return false;
            
            // 创建日期范围
            if (filters.createStartDate && item.createDate < filters.createStartDate) return false;
            if (filters.createEndDate && item.createDate > filters.createEndDate) return false;
            
            // 联系电话模糊匹配
            if (filters.phone && (!item.phone || !item.phone.includes(filters.phone))) return false;
            
            return true;
          });
          
          // 更新数据列表
          renderDataList();
          
          // 关闭提示
          promptModal.hide();
        }, 800);
      }

      // 渲染数据列表
      function renderDataList() {
        const dataList = $('#dataList');
        dataList.empty();
        
        if (allData.length === 0) {
          dataList.append(`
            <tr>
              <td colspan="15" class="text-center text-muted">没有找到符合条件的数据</td>
            </tr>
          `);
        } else {
          allData.forEach(item => {
            // 计算年龄
            const age = item.birthDate ? calculateAge(item.birthDate) : '-';
            // 获取性别
            const gender = item.gender || (item.idCard && item.idCard.length === 18 ? 
              (parseInt(item.idCard.substr(16, 1)) % 2 === 0 ? '女' : '男') : '-');
            
            // 服务状态标签
            const statusClass = {
              '正常': 'status-normal',
              '暂停': 'status-pause',
              '转出': 'status-transfer',
              '死亡': 'status-death'
            }[item.serviceStatus] || '';
            
            dataList.append(`
              <tr>
                <td>
                  <input type="checkbox" name="dataItem" value="${item.id}" 
                    ${selectedRows.includes(item.id) ? 'checked' : ''}>
                </td>
                <td>${item.name}</td>
                <td>${item.idCard}</td>
                <td>${gender}</td>
                <td>${age}</td>
                <td>${item.phone || '<span class="text-muted">-</span>'}</td>
                <td>${item.region || '<span class="text-muted">-</span>'}</td>
                <td>${item.orgName || '<span class="text-muted">-</span>'}</td>
                <td>${item.disabilityLevel}</td>
                <td>${item.medicalType || '<span class="badge-warning">未填写</span>'}</td>
                <td>
                  ${item.medicalStatus === '已绑定' ? 
                    '<span class="badge" style="background-color: #E6F7E6; color: #52C41A;">已绑定</span>' : 
                    '<span class="badge" style="background-color: #FFF1F0; color: #FF4D4F;">未绑定</span>'}
                </td>
                <td>
                  <span class="status-badge ${statusClass}">${item.serviceStatus || '正常'}</span>
                </td>
                <td>${item.publishDate || '<span class="text-muted">-</span>'}</td>
                <td>${item.createDate || '<span class="text-muted">-</span>'}</td>
                <td>
                  <button class="btn btn-sm btn-outline-secondary view-detail-btn" data-id="${item.id}">
                    <i class="fa fa-eye"></i> 查看
                  </button>
                </td>
              </tr>
            `);
          });
        }
        
        // 更新总数显示
        $('#totalCount').text(allData.length);
        
        // 更新全选框状态
        $('#checkAll').prop('checked', false);
        
        // 更新导出按钮状态
        updateExportButtonStatus();
        
        // 更新导出全部按钮状态
        $('#exportAllBtn').prop('disabled', allData.length === 0);
      }

      // 加载导出历史记录
      function loadExportLogs() {
        // 模拟加载历史记录
        const today = new Date();
        const dateStr = today.getFullYear() + 
                        String(today.getMonth() + 1).padStart(2, '0') + 
                        String(today.getDate()).padStart(2, '0');
        const timeStr = String(today.getHours()).padStart(2, '0') + ':' + 
                        String(today.getMinutes()).padStart(2, '0') + ':' + 
                        String(today.getSeconds()).padStart(2, '0');
        
        const logs = [
          { id: 'log1', time: `${dateStr} ${timeStr}`, user: '系统管理员', template: '标准格式 - 全部字段', count: validData.length, file: `服务对象查询结果_${dateStr}.xls` },
          { id: 'log2', time: '2025-10-18 14:30:25', user: '系统管理员', template: '绍兴市 - 批量登记模版', count: 15, file: '绍兴市服务对象_20251018.xls' },
          { id: 'log3', time: '2025-10-15 09:45:12', user: '系统管理员', template: '标准格式 - 全部字段', count: 8, file: '服务对象查询结果_20251015.xls' },
          { id: 'log4', time: '2025-10-10 16:20:33', user: '系统管理员', template: '绍兴市 - 批量登记模版', count: 12, file: '绍兴市服务对象_20251010.xls' },
        ];
        
        const logList = $('#logList');
        logList.empty();
        
        logs.forEach(log => {
          logList.append(`
            <tr>
              <td>${log.time}</td>
              <td>${log.user}</td>
              <td>${log.template}</td>
              <td>${log.count}</td>
              <td>
                <button class="btn btn-sm btn-outline-secondary download-log-btn" data-file="${log.file}">
                  <i class="fa fa-download"></i> 下载
                </button>
              </td>
            </tr>
          `);
        });
      }

      // 数据校验函数
      function validateData(data) {
        const valid = [];
        const invalid = [];
        
        data.forEach(item => {
          const errors = [];
          
          // 校验必填字段
          if (!item.name) errors.push('姓名不能为空');
          if (!item.idCard || item.idCard.length !== 18) errors.push('身份证号格式不正确');
          if (!item.disabilityLevel) errors.push('失能等级不能为空');
          if (!item.medicalType) errors.push('医保类型未填写');
          if (!item.address) errors.push('居住地址未填写');
          if (!item.publishDate) errors.push('公示日期不能为空');
          
          if (errors.length === 0) {
            valid.push(item);
          } else {
            invalid.push({
              ...item,
              reason: errors.join('；')
            });
          }
        });
        
        return { valid, invalid };
      }

      // 开始导出函数
      function startExport() {
        if (validData.length === 0) {
          showPrompt('操作提示', '没有可导出的数据！');
          return;
        }
        
        // 显示导出中模态框
        exportingModal.show();
        
        // 获取选中的模板
        const templateValue = $('#regionTemplate').val();
        const template = $('#regionTemplate option:selected').text();
        
        // 模拟导出延迟
        setTimeout(() => {
          // 生成文件名：服务对象查询结果+日期
          const today = new Date();
          const dateStr = today.getFullYear() + 
                          String(today.getMonth() + 1).padStart(2, '0') + 
                          String(today.getDate()).padStart(2, '0');
          
          let fileName = `服务对象查询结果_${dateStr}.xls`;
          
          // 如果选择了地区模板，使用模板名称
          if (templateValue && templateValue !== 'standard') {
            let regionName = '';
            if (templateValue.includes('shaoxing')) regionName = '绍兴市';
            else if (templateValue.includes('hangzhou')) regionName = '杭州市';
            else if (templateValue.includes('ningbo')) regionName = '宁波市';
            fileName = `${regionName}服务对象_${dateStr}.xls`;
          }
          
          // 关闭导出中模态框
          exportingModal.hide();
          
          // 显示导出成功提示
          showPrompt('导出成功', `Excel文件已生成：<br><strong>${fileName}</strong><br><br>共导出 <strong>${validData.length}</strong> 条数据<br><br>点击确定开始下载`);
          
          // 模拟下载文件
          setTimeout(() => {
            promptModal.hide();
            // 实际项目中触发文件下载
            // const exportUrl = `/api/export/service-object?template=${templateValue || 'standard'}&data=${JSON.stringify(validData)}`;
            // window.location.href = exportUrl;
            
            // 记录导出日志（实际项目中应调用接口保存）
            loadExportLogs();
            
            // 清空选择
            selectedRows = [];
            $('#checkAll').prop('checked', false);
            updateExportButtonStatus();
          }, 1500);
        }, 2000);
      }

      // 更新导出按钮状态
      function updateExportButtonStatus() {
        const hasSelected = selectedRows.length > 0;
        
        $('#exportSelectedBtn').prop('disabled', !hasSelected);
        $('#exportSelectedBtn').toggleClass('btn-disabled', !hasSelected);
      }

      // 显示提示信息
      function showPrompt(title, msg) {
        $('#promptTitle').text(title);
        $('#promptMsg').html(msg);
        promptModal.show();
      }

      // 格式化日期为YYYY-MM-DD
      function formatDate(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
      }
      
      // 计算年龄
      function calculateAge(birthDate) {
        if (!birthDate) return '-';
        const birth = new Date(birthDate);
        const today = new Date();
        let age = today.getFullYear() - birth.getFullYear();
        const monthDiff = today.getMonth() - birth.getMonth();
        if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
          age--;
        }
        return age;
      }

      // 监听模板选择变化（不再需要，导出按钮不再依赖模板）
    });
  </script>
</body>
</html>